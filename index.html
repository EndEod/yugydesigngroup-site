<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ëš±ëšœë£¨ì˜ ë„ë©´ì†Œìƒìˆ </title>

  <!-- 2D/ì…ë©´ ìº¡ì²˜ìš© -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#f2f2f2;
      --panel:#ffffff;
      --ink:#222;
      --muted:#666;
      --line:#e7e7e7;
      --btn:#1f2937;
      --btn2:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
      --radius:14px;
    }
    body{ margin:0; overflow:hidden; font-family:"Segoe UI","Malgun Gothic",system-ui,sans-serif; background:var(--bg); color:var(--ink); }
    button{ font:inherit; cursor:pointer; }
    a{ color:inherit; }

    #ui{
      position:fixed; left:12px; top:12px; z-index:1000;
      width:360px; max-height:92vh; overflow:auto;
      background:rgba(255,255,255,.97);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.12);
      padding:12px;
    }
    #ui::-webkit-scrollbar{ width:6px; }
    #ui::-webkit-scrollbar-thumb{ background:#cfcfcf; border-radius:10px; }

    .topRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .title{ font-weight:800; font-size:16px; display:flex; align-items:center; gap:8px; }
    .ver{ font-size:11px; padding:2px 6px; border-radius:6px; background:#111827; color:#fff; }

    .topBtns{ display:flex; gap:6px; }
    .miniBtn{
      border:1px solid var(--line); background:#fff; color:var(--ink);
      padding:7px 9px; border-radius:10px; font-size:12px;
    }
    .miniBtn:hover{ background:#f6f6f6; }
    .miniBtn.danger{ border-color:#ffd1d1; color:var(--danger); }
    .miniBtn.primary{ border-color:#c7ddff; color:#1d4ed8; }

    .modeRow{ margin-top:10px; display:flex; gap:8px; }
    .modeBtn{
      flex:1; border:none; border-radius:12px; padding:10px 0;
      background:#e9e9e9; color:#666; font-weight:900;
    }
    .modeBtn.active{ background:var(--btn); color:#fff; }

    .block{ margin-top:10px; border:1px solid var(--line); border-radius:12px; padding:10px; background:#fff; }
    .hint{ font-size:12px; color:var(--muted); line-height:1.5; }

    input[type=number]{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border:1px solid #d8d8d8;
      border-radius:12px;
      font-size:12px;
      outline:none;
    }
    input[type=number]:focus{ border-color:#a7c7ff; box-shadow:0 0 0 3px rgba(37,99,235,.12); }

    textarea{
      width:100%; height:160px; box-sizing:border-box;
      margin-top:8px;
      border:1px solid #d8d8d8; border-radius:12px;
      padding:10px; font-size:12px; resize:vertical;
      user-select:text;
    }
    .rowBtns{ display:flex; gap:8px; margin-top:8px; }
    .rowBtns button{ flex:1; }

    #buildBtn{
      width:100%; margin-top:10px;
      border:none; border-radius:12px;
      padding:12px 0; font-weight:900; font-size:14px;
      background:var(--btn2); color:#fff;
    }
    #buildBtn:hover{ filter:brightness(0.95); }

    #status{
      margin-top:10px; font-size:12px; line-height:1.45;
      color:var(--muted);
      background:#f8fafc; border:1px solid #eef2ff;
      padding:10px; border-radius:12px;
    }
    #status b{ color:var(--ink); }
    .ok{ color:var(--ok); font-weight:900; }
    .bad{ color:var(--danger); font-weight:900; }

    details{ margin-top:10px; }
    summary{
      cursor:pointer; font-weight:900; font-size:13px;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .detailsBody{
      margin-top:8px; font-size:12px; color:var(--muted); line-height:1.6;
      border:1px dashed #e5e7eb; border-radius:12px; padding:10px; background:#fafafa;
    }
    kbd{ background:#fff; border:1px solid #ddd; padding:1px 6px; border-radius:6px; font-family:monospace; font-weight:900; }

    /* Viewer */
    #viewer{ position:fixed; inset:0; z-index:1; }

    #twod{ position:absolute; inset:0; overflow:auto; display:none; background:#fff;
      background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px);
      background-size:40px 40px;
    }
    #three{ position:absolute; inset:0; display:block; }
    #elev{ position:absolute; inset:0; overflow:auto; display:none; background:#fff;
      background-image: linear-gradient(#f0f0f0 1px, transparent 1px), linear-gradient(90deg, #f0f0f0 1px, transparent 1px);
      background-size:40px 40px;
      padding:18px 18px 80px 18px;
      box-sizing:border-box;
    }

    .room2d{
      position:absolute; border:2px solid #666; box-shadow:2px 2px 6px rgba(0,0,0,.12);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      font-size:12px; padding:6px; cursor:grab; user-select:none; touch-action:none;
    }
    .room2d.dragging{ cursor:grabbing; opacity:.85; z-index:999; box-shadow:6px 6px 16px rgba(0,0,0,.18); }

    /* ì…ë©´ ì¹´ë“œ */
    .elevHeader{
      position:sticky; top:0; z-index:5;
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      backdrop-filter: blur(6px);
      margin-bottom:14px;
    }
    .elevGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(330px, 1fr));
      gap:14px;
    }
    .elevCard{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      box-shadow:0 10px 22px rgba(0,0,0,.07);
    }
    .elevTitle{ font-weight:900; font-size:14px; margin-bottom:8px; }
    .elevMeta{ font-size:12px; color:var(--muted); margin-bottom:10px; line-height:1.4; }
    .wallRow{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .wallBox{
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:10px;
      background:#fafafa;
    }
    .wallLabel{ font-weight:900; font-size:12px; margin-bottom:6px; color:#111; }
    .wallSvgWrap{ width:100%; overflow:hidden; }
    .warn{ margin-top:8px; font-size:12px; color:var(--danger); font-weight:900; }
    .good{ margin-top:8px; font-size:12px; color:var(--ok); font-weight:900; }

    /* Tooltip (3D) */
    #tooltip{
      position:fixed; display:none; z-index:9999; pointer-events:none;
      background:rgba(17,24,39,.95); color:#fff;
      padding:10px 12px; border-radius:12px;
      font-size:12px; line-height:1.55;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      min-width:220px;
      border:1px solid rgba(255,255,255,.12);
    }
    #tooltip b{ display:block; font-size:13px; margin-bottom:6px; color:#fde68a; }
    .ttRow{ display:flex; justify-content:space-between; gap:12px; }
    .ttLbl{ color:#cbd5e1; }
    .ttVal{ font-weight:900; }
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>

<body>
  <div id="tooltip"></div>

  <div id="ui">
    <div class="topRow">
      <div class="title">ëš±ëšœë£¨ì˜ ë„ë©´ì†Œìƒìˆ  <span class="ver">v2.32</span></div>
      <div class="topBtns">
        <button id="resetBtn" class="miniBtn danger">ì´ˆê¸°í™”</button>
        <button id="jsonLoadBtn" class="miniBtn">JSON ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="jsonSaveBtn" class="miniBtn primary">JSON ì €ì¥</button>
        <input id="jsonFile" type="file" accept="application/json" style="display:none" />
      </div>
    </div>

    <div class="modeRow">
      <button id="mode2d" class="modeBtn">ğŸ“Š 2D</button>
      <button id="mode3d" class="modeBtn active">ğŸ§Š 3D</button>
      <button id="modeElev" class="modeBtn">ğŸ§± ì…ë©´</button>
    </div>

    <div class="block">
      <div class="hint">
        <b>ë”± 2ë‹¨ê³„ë§Œ í•˜ì„¸ìš”.</b><br/>
        1) ì•„ë˜ ì¹¸ì— â€œë°© ëª©ë¡â€ ë¶™ì—¬ë„£ê¸°<br/>
        2) <b>[ë„ë©´ ìƒì„±]</b> ëˆ„ë¥´ê¸°
      </div>

      <!-- ë²½ë‘ê»˜ ì…ë ¥ (ê¸°ë³¸ 200mm) -->
      <div style="margin-top:10px;">
        <div style="font-size:12px;font-weight:900;color:#111;">ë²½ë‘ê»˜(mm) <span style="font-weight:700;color:#666;">(ê¸°ë³¸ 200, ë¹„ì›Œë„ ìë™ 200)</span></div>
        <input id="wallThk" type="number" value="200" min="50" max="500" step="10" />
        <div class="hint" style="margin-top:6px;">
          Â· 200ì²˜ëŸ¼ í° ê°’ì€ <b>mm</b>ë¡œ ë³´ê³  0.2më¡œ ë³€í™˜í•©ë‹ˆë‹¤.<br/>
          Â· 0.2ì²˜ëŸ¼ ì‘ì€ ê°’ì€ <b>m</b>ë¡œ ë´…ë‹ˆë‹¤.
        </div>
      </div>

      <textarea id="dataInput" placeholder="ì˜ˆì‹œ(íƒ­/ì‰¼í‘œ/ê³µë°± ë‹¤ ë¨)
1	ê±°ì‹¤	5.0	4.0	2.3	(ì„ íƒ)ì°½ë©´ì =3.2
2	ì¹¨ì‹¤	3.5	3.0	2.3
â€» ì—‘ì…€/êµ¬ê¸€ì‹œíŠ¸ëŠ” í‘œ í†µì§¸ë¡œ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ì–´ë„ ë©ë‹ˆë‹¤."></textarea>

      <div class="rowBtns">
        <button id="pasteBtn" class="miniBtn">ğŸ“‹ í´ë¦½ë³´ë“œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="sampleBtn" class="miniBtn">ğŸ§ª ìƒ˜í”Œ ë„£ê¸°</button>
        <button id="clearInputBtn" class="miniBtn">ğŸ§½ ì…ë ¥ ì§€ìš°ê¸°</button>
      </div>

      <button id="buildBtn">ğŸ—ï¸ ë„ë©´ ìƒì„±</button>

      <div id="status">
        <b>ìƒíƒœ</b><br/>
        ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ ì¹¸ì— ë¶™ì—¬ë„£ê³  [ë„ë©´ ìƒì„±]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      </div>

      <details>
        <summary>ì‚¬ìš©ë²• (30ì´ˆ)</summary>
        <div class="detailsBody">
          1) ì—‘ì…€/êµ¬ê¸€ì‹œíŠ¸ì—ì„œ <b>ë°© ëª©ë¡ í‘œ</b>ë¥¼ ë“œë˜ê·¸í•´ì„œ ë³µì‚¬<br/>
          2) ì´ í˜ì´ì§€ì— ë¶™ì—¬ë„£ê¸°<br/>
          3) <b>[ë„ë©´ ìƒì„±]</b><br/><br/>
          - 2D: ë°© ì¡°ê°ì„ ë“œë˜ê·¸ë¡œ ë§ì¶”ê¸°<br/>
          - 3D: <kbd>Shift</kbd> ëˆ„ë¥´ê³  ë“œë˜ê·¸í•˜ë©´ ë°© ì´ë™<br/>
          - ì…ë©´: ìë™ ì „ê°œë„(4ë©´) ë³´ê¸°<br/><br/>
          <span class="bad">ìƒˆë¡œê³ ì¹¨(F5)ì€ ë¸Œë¼ìš°ì €ê°€ ì…ë ¥ì„ ë³µì›í•  ìˆ˜ ìˆì–´ìš”.</span><br/>
          í•­ìƒ <b>[ì´ˆê¸°í™”]</b>ë¡œ ë¦¬ì…‹í•˜ëŠ” ê²Œ ì œì¼ ê¹”ë”í•©ë‹ˆë‹¤.
        </div>
      </details>

      <details>
        <summary>ë©´ì /ë³´ì • ì„¤ëª… (ì¤‘ìš”)</summary>
        <div class="detailsBody">
          âœ… <b>ìˆœë©´ì (ì—‘ì…€ ë™ì¼)</b> = ê°€ë¡œÃ—ì„¸ë¡œ<br/>
          âš ï¸ <b>ë²½ í¬í•¨ ì¶”ì •ë©´ì (ì°¸ê³ )</b> = (ê°€ë¡œ+2t)Ã—(ì„¸ë¡œ+2t)<br/><br/>
          ë‹¨, ë°©ë¼ë¦¬ ë¶™ì–´ ìˆìœ¼ë©´ ê³µìœ ë²½ì´ ìƒê¸°ë¯€ë¡œ<br/>
          â€œë²½ í¬í•¨ ì¶”ì •ë©´ì â€ì€ <b>ë°©ë³„ ìµœëŒ€ì¹˜</b> ëŠë‚Œìœ¼ë¡œ ë³´ì„¸ìš”(ì¤‘ë³µ ê°€ëŠ¥).<br/><br/>
          ê·¸ë˜ì„œ ì´ ì‚¬ì´íŠ¸ëŠ” <b>ì—‘ì…€ê³¼ ê°™ì€ ìˆœë©´ì </b>ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ìœ ì§€í•˜ê³ ,<br/>
          ë²½ë‘ê»˜ëŠ” <b>3D ë²½ ë‘ê»˜/ë²½ì²´ë¶€í”¼ ì¶”ì •</b>ì— íŠ¹íˆ ìœ ìš©í•˜ê²Œ ì“°ì…ë‹ˆë‹¤.
        </div>
      </details>

      <details>
        <summary>ë°ì´í„° í˜•ì‹ (ì¤‘ìš”)</summary>
        <div class="detailsBody">
          ìµœì†Œ 4ê°œë§Œ ìˆìœ¼ë©´ ë©ë‹ˆë‹¤: <b>ID / ë°©ì´ë¦„ / ê°€ë¡œ / ì„¸ë¡œ</b><br/>
          ë†’ì´ëŠ” ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ <b>2.3m</b>ë¥¼ ì”ë‹ˆë‹¤.<br/><br/>
          âœ… ë‹¨ìœ„ ìë™ ì¶”ì •<br/>
          - 5.0 â†’ 5m<br/>
          - 5000 â†’ 5000mm â†’ 5më¡œ ë³€í™˜<br/><br/>
          (ì„ íƒ) ì°½ë¬¸ì€ ì´ˆë³´ìš©ìœ¼ë¡œ <b>ì´ ì°½ë©´ì (ã¡)</b>ë§Œ ë„£ì–´ë„ ë©ë‹ˆë‹¤.<br/>
          ì…ë©´ì—ì„œëŠ” ì´ ì°½ë©´ì ì„ <b>4ë©´ì— ë²½ë©´ì  ë¹„ìœ¨ë¡œ ìë™ ë¶„ë°°</b>í•´ì„œ ë³´ì—¬ì¤˜ìš”.
        </div>
      </details>

      <details>
        <summary>ë‹¨ì¶•í‚¤</summary>
        <div class="detailsBody">
          <b>ê³µí†µ</b>: <kbd>P</kbd> ìº¡ì²˜ ì €ì¥ ğŸ“¸<br/>
          <b>3D</b>: <kbd>Shift</kbd>+ë“œë˜ê·¸ ë°© ì´ë™ / <kbd>L</kbd> ë¼ë²¨ í† ê¸€ / <kbd>G</kbd> ì •ë‹µìœ ë ¹ í† ê¸€
        </div>
      </details>

      <details>
        <summary>ë‹¤ìš´ë¡œë“œ/ìƒë‹´</summary>
        <div class="detailsBody">
          ğŸ“‚ ì—‘ì…€í‚¤íŠ¸: <a href="https://drive.google.com/file/d/112Y3BEiE_1ooNrF5tPZd6SnDRHyXcrDg/view?usp=sharing" target="_blank">ë‹¤ìš´</a><br/>
          ğŸ“‘ êµ¬ê¸€ì‹œíŠ¸ ì‚¬ë³¸: <a href="https://docs.google.com/spreadsheets/d/1GW5nJHgax0XTXOPyyVusVr_WKob3S5URJG1lSiAM6bE/copy" target="_blank">ì‚¬ë³¸ ë§Œë“¤ê¸°</a><br/>
          ğŸ’¬ í†¡í†¡: <a href="https://talk.naver.com/W4HB1I" target="_blank">ìƒë‹´í•˜ê¸°</a><br/>
          ğŸŒ¿ ê·¸ë¦°ë¦¬ëª¨ë¸ë§: <a href="https://yugy.store" target="_blank">yugy.store</a>
        </div>
      </details>
    </div>
  </div>

  <div id="viewer">
    <div id="twod"></div>
    <div id="three"></div>
    <div id="elev"></div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // -----------------------------
    // 0) ìƒíƒœ/íŒ”ë ˆíŠ¸
    // -----------------------------
    const EXCEL_COLORS = [
      "#FFCCCC","#FFE5CC","#FFFFCC","#E5FFCC","#CCFFCC","#CCFFE5","#CCFFFF","#CCE5FF","#CCCCFF","#E5CCFF",
      "#FFCCFF","#FFCCE5","#FFB2B2","#FFD6A5","#FFEF9F","#CAE799","#A6E3A1","#99DDCC","#9FDBFF","#ADC1FF",
      "#C8B2FF","#E0B2FF","#FFB2F5","#FFB2D7","#FFB2B2","#FF8282","#FFAA64","#FFD246","#B4DC5A","#78D296"
    ];

    let mode = '3d';
    let globalData = []; // {id,name,w,d,h,winArea, x2d,y2d}
    let globalWallThicknessMm = 200; // ê¸°ë³¸ê°’
    let globalWallThicknessM = 0.2;

    const $ = (id) => document.getElementById(id);
    const statusEl = $('status');
    const inputEl = $('dataInput');
    const tooltip = $('tooltip');

    function setStatus(html){ statusEl.innerHTML = html; }

    // -----------------------------
    // 1) ë‹¨ìœ„/íŒŒì„œ
    // -----------------------------
    function numOnly(v){
      if (v === null || v === undefined) return '';
      return String(v).replace(/[^0-9.\-]/g,'').trim();
    }
    function smartUnit(v){
      const s = numOnly(v);
      const n = parseFloat(s);
      if (!isFinite(n) || n <= 0) return 0;
      if (n > 100) return n / 1000; // mm ì¶”ì •
      return n;
    }
    function smartThickness(v, fallbackM){
      const s = numOnly(v);
      const n = parseFloat(s);
      if (!isFinite(n) || n <= 0) return fallbackM;
      if (n > 10) return n / 1000; // 200 -> 0.2m
      return n; // 0.2 -> 0.2m
    }
    function getGlobalThickness(){
      const raw = $('wallThk').value;
      let t = smartThickness(raw, 0.2);
      // ë„ˆë¬´ ì–‡ê±°ë‚˜ ì´ìƒí•˜ë©´ ì•ˆì „í•˜ê²Œ 0.2ë¡œ
      if (!isFinite(t) || t <= 0) t = 0.2;
      if (t < 0.03) t = 0.03; // ìµœì†Œ 30mm
      if (t > 1.0) t = 1.0;   // ìµœëŒ€ 1m
      globalWallThicknessM = t;
      globalWallThicknessMm = Math.round(t*1000);
      return t;
    }

    function splitCols(line){
      const t = (line || '').trim();
      if (!t) return null;
      if (t.includes('\t')) return t.split('\t').map(x=>x.trim());
      if (t.includes(',')) return t.split(',').map(x=>x.trim());
      return t.split(/\s+/).map(x=>x.trim());
    }
    function detectHeader(cols){
      const lower = cols.map(c => String(c).toLowerCase().replace(/\s/g,''));
      const map = {};
      lower.forEach((c,i)=>{
        if (/ê³µê°„id|ë°©id|id|ë²ˆí˜¸/.test(c)) map.id=i;
        if (/ê³µê°„ëª…|ë°©ì´ë¦„|ì´ë¦„|name/.test(c)) map.name=i;
        if (/ê°€ë¡œ|width|w|ê¸¸ì´/.test(c)) map.w=i;
        if (/ì„¸ë¡œ|depth|d|ë„ˆë¹„/.test(c)) map.d=i;
        if (/ë²½ë†’ì´|ë†’ì´|height|h/.test(c)) map.h=i;
        if (/ì°½ë©´ì |ì°½ë¬¸ë©´ì |windowarea|winarea/.test(c)) map.winArea=i;
      });
      if (map.name !== undefined && map.w !== undefined && map.d !== undefined) return map;
      return null;
    }

    function parseText(text){
      const lines = String(text||'').split(/\r?\n/);
      const parsed = [];
      let headerMap = null;
      let autoId = 1;
      let skipped = 0;

      for (const line of lines){
        const cols = splitCols(line);
        if (!cols) continue;

        if (!headerMap){
          const hm = detectHeader(cols);
          if (hm){
            headerMap = hm;
            continue;
          }
        }

        const idxId = headerMap?.id ?? 0;
        const idxName = headerMap?.name ?? 1;
        const idxW = headerMap?.w ?? 2;
        const idxD = headerMap?.d ?? 3;
        const idxH = headerMap?.h ?? 4;
        const idxWin = headerMap?.winArea;

        const name = String(cols[idxName] ?? '').trim();
        if (!name){ skipped++; continue; }

        let id = parseInt(numOnly(cols[idxId] ?? ''),10);
        if (!isFinite(id) || id <= 0) id = autoId;

        const w = smartUnit(cols[idxW]);
        const d = smartUnit(cols[idxD]);
        let h = smartUnit(cols[idxH]);
        if (!h) h = 2.3;

        let winArea = 0;
        if (idxWin !== undefined){
          const wa = parseFloat(numOnly(cols[idxWin]));
          if (isFinite(wa) && wa > 0) winArea = wa;
        } else {
          const joined = cols.join(' ');
          const m = joined.match(/ì°½ë©´ì \s*=?\s*([0-9.]+)/);
          if (m){
            const wa = parseFloat(m[1]);
            if (isFinite(wa) && wa > 0) winArea = wa;
          }
        }

        if (w > 0 && d > 0){
          parsed.push({ id, name, w, d, h, winArea });
          autoId = Math.max(autoId, id + 1);
        } else {
          skipped++;
        }
      }
      return { parsed, skipped };
    }

    // -----------------------------
    // 2) ì´ˆê¸°í™”
    // -----------------------------
    const twod = $('twod');
    const elev = $('elev');
    const threeEl = $('three');

    function hardReset({ clearInput=true } = {}){
      twod.innerHTML = '';
      elev.innerHTML = '';

      pieces.forEach(p => scene.remove(p));
      ghosts.forEach(g => scene.remove(g));
      pieces = []; ghosts = []; hitMeshes = []; labels3D = [];
      dragging = false; draggedGroup = null;

      globalData = [];
      if (clearInput) inputEl.value = '';

      tooltip.style.display = 'none';
      setStatus(`<b>ìƒíƒœ</b><br/>ì´ˆê¸°í™” ì™„ë£Œ. ë‹¤ì‹œ ë¶™ì—¬ë„£ê³  <b>[ë„ë©´ ìƒì„±]</b> ëˆ„ë¥´ì„¸ìš”.`);
    }

    window.addEventListener('pageshow', (e)=>{
      if (e.persisted) hardReset({ clearInput:true });
    });

    // -----------------------------
    // 3) 2D
    // -----------------------------
    const SCALE_2D = 40;
    let active2D = null;
    let active2DOffset = { x:0, y:0 };

    function build2D(){
      twod.innerHTML = '';
      if (!globalData.length) return;

      const START_X = 380, START_Y = 40, LIMIT = 980, GAP = 18;
      let x = START_X, y = START_Y, rowH = 0;

      const title = document.createElement('div');
      title.style.position='absolute';
      title.style.left='16px';
      title.style.top='10px';
      title.style.fontWeight='900';
      title.style.fontSize='14px';
      title.textContent='2D ëª¨ë“œ: ë°© ì¡°ê°ì„ ë“œë˜ê·¸í•´ì„œ ë§ì¶”ì„¸ìš”';
      twod.appendChild(title);

      globalData.forEach((d)=>{
        const color = EXCEL_COLORS[(d.id-1) % EXCEL_COLORS.length] || '#ddd';
        const wPx = d.w * SCALE_2D;
        const dPx = d.d * SCALE_2D;

        if (x + wPx > START_X + LIMIT){ x = START_X; y += rowH + GAP; rowH = 0; }

        const div = document.createElement('div');
        div.className='room2d';
        div.dataset.id = d.id;
        div.style.left = (d.x2d ?? (x+'px'));
        div.style.top = (d.y2d ?? (y+'px'));
        div.style.width = wPx+'px';
        div.style.height = dPx+'px';
        div.style.background = color;
        div.innerHTML = `<b>${d.name}</b><span style="font-size:11px;color:#111">(${d.w}Ã—${d.d}m)</span>`;
        twod.appendChild(div);

        x += wPx + GAP;
        rowH = Math.max(rowH, dPx);
      });
    }

    function save2DPositions(){
      const nodes = twod.querySelectorAll('.room2d');
      nodes.forEach(n=>{
        const id = parseInt(n.dataset.id,10);
        const m = globalData.find(x=>x.id===id);
        if (m){
          m.x2d = n.style.left;
          m.y2d = n.style.top;
        }
      });
    }

    twod.addEventListener('pointerdown', (e)=>{
      const target = e.target.closest('.room2d');
      if (!target) return;
      active2D = target;
      active2D.classList.add('dragging');
      const r = active2D.getBoundingClientRect();
      active2DOffset.x = e.clientX - r.left;
      active2DOffset.y = e.clientY - r.top;
    });
    twod.addEventListener('pointermove', (e)=>{
      if (!active2D) return;
      e.preventDefault();
      const c = twod.getBoundingClientRect();
      const cx = e.clientX - c.left + twod.scrollLeft;
      const cy = e.clientY - c.top + twod.scrollTop;
      active2D.style.left = (cx - active2DOffset.x) + 'px';
      active2D.style.top  = (cy - active2DOffset.y) + 'px';
    });
    function end2D(){
      if (!active2D) return;
      active2D.classList.remove('dragging');
      active2D = null;
      save2DPositions();
    }
    twod.addEventListener('pointerup', end2D);
    twod.addEventListener('pointerleave', end2D);

    // -----------------------------
    // 4) ì…ë©´(ìë™ ì „ê°œë„)
    // -----------------------------
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    function wallSVG(wallW, h, winArea, colorHex, label){
      const wallArea = wallW * h;
      const invalid = winArea > wallArea * 0.98;

      const aspect = 1.6;
      let patchW = winArea > 0 ? Math.sqrt(winArea * aspect) : 0;
      let patchH = winArea > 0 ? (winArea / patchW) : 0;

      patchW = clamp(patchW, 0, wallW * 0.9);
      patchH = clamp(patchH, 0, h * 0.8);

      const vbW = wallW;
      const vbH = h;

      const px = (vbW - patchW) / 2;
      const py = (vbH - patchH) * 0.45;

      const wallStroke = "#111827";
      const wallFill = colorHex;
      const winFill = invalid ? "rgba(255,77,77,0.45)" : "rgba(102,204,255,0.32)";
      const winStroke = invalid ? "#7f0000" : "#0b4aa2";

      const svg = `
        <svg viewBox="0 0 ${vbW} ${vbH}" width="100%" preserveAspectRatio="xMidYMid meet">
          <rect x="${vbW*0.08}" y="${vbH*0.08}" width="${vbW*(1-0.16)}" height="${vbH*(1-0.16)}"
            fill="${wallFill}" fill-opacity="0.75" stroke="${wallStroke}" stroke-width="${Math.max(0.02, vbW*0.01)}" rx="${vbW*0.05}" />
          ${
            winArea>0 ? `
            <rect x="${px}" y="${py}" width="${patchW}" height="${patchH}"
              fill="${winFill}" stroke="${winStroke}" stroke-width="${Math.max(0.02, vbW*0.01)}" rx="${vbW*0.04}" />
            ` : ''
          }
          <text x="${vbW*0.5}" y="${vbH*0.12}" text-anchor="middle" font-size="${Math.max(0.18, vbW*0.06)}"
            font-family="Malgun Gothic, system-ui" font-weight="900" fill="#111">${label}</text>
        </svg>
      `;
      return { svg, invalid };
    }

    function buildElevation(){
      elev.innerHTML = '';
      if (!globalData.length) return;

      const t = globalWallThicknessM;

      const totalFloorNet = globalData.reduce((s,r)=>s + (r.w*r.d), 0);
      const totalFloorGrossEst = globalData.reduce((s,r)=>s + ((r.w+2*t)*(r.d+2*t)), 0);
      const totalWallInner = globalData.reduce((s,r)=>s + ((r.w+r.d)*2*r.h), 0);
      const totalWallOuter = globalData.reduce((s,r)=>s + (((r.w+2*t)+(r.d+2*t))*2*r.h), 0);
      const totalWin = globalData.reduce((s,r)=>s + (r.winArea||0), 0);
      const totalWallVolEst = globalData.reduce((s,r)=>{
        const periOuter = ((r.w+2*t)+(r.d+2*t))*2;
        return s + (periOuter * t * r.h);
      }, 0);

      const header = document.createElement('div');
      header.className = 'elevHeader';
      header.innerHTML = `
        <div style="font-weight:900;font-size:14px;">ì…ë©´(ì „ê°œë„) ìë™ ìƒì„±</div>
        <div style="margin-top:6px;font-size:12px;color:#666;line-height:1.45;">
          ë²½ë‘ê»˜: <b>${(t*1000).toFixed(0)}mm</b><br/>
          ë°© ${globalData.length}ê°œ Â· ìˆœë©´ì (ì—‘ì…€ ë™ì¼) <b>${totalFloorNet.toFixed(2)}ã¡</b> Â· ë²½ í¬í•¨ ì¶”ì •(ì°¸ê³ ) <b>${totalFloorGrossEst.toFixed(2)}ã¡</b><br/>
          ë²½ë©´ì (ë‚´ì¸¡) <b>${totalWallInner.toFixed(2)}ã¡</b> Â· ë²½ë©´ì (ì™¸ì¸¡ ì¶”ì •) <b>${totalWallOuter.toFixed(2)}ã¡</b> Â· ì°½ë©´ì  <b>${totalWin.toFixed(2)}ã¡</b><br/>
          ë²½ì²´ë¶€í”¼(ì¶”ì •) <b>${totalWallVolEst.toFixed(2)}ã¥</b><br/>
          <span style="color:#111;font-weight:900;">ìº¡ì²˜:</span> <kbd>P</kbd> (í˜„ì¬ í™”ë©´ PNG ì €ì¥)
        </div>
      `;
      elev.appendChild(header);

      const grid = document.createElement('div');
      grid.className = 'elevGrid';
      elev.appendChild(grid);

      globalData.forEach((r)=>{
        const color = EXCEL_COLORS[(r.id-1) % EXCEL_COLORS.length] || "#ddd";
        const wallAreas = [
          { key:'ì•', w:r.w, area:r.w*r.h },
          { key:'ë’¤', w:r.w, area:r.w*r.h },
          { key:'ì¢Œ', w:r.d, area:r.d*r.h },
          { key:'ìš°', w:r.d, area:r.d*r.h },
        ];
        const totalA = wallAreas.reduce((s,x)=>s+x.area,0) || 1;

        const win = r.winArea || 0;
        const alloc = wallAreas.map(x => win * (x.area/totalA));

        const card = document.createElement('div');
        card.className = 'elevCard';
        card.innerHTML = `
          <div class="elevTitle">${r.name}</div>
          <div class="elevMeta">
            ì¹˜ìˆ˜: <b>${r.w}Ã—${r.d}Ã—${r.h}m</b> Â· ë²½ë‘ê»˜ <b>${(t*1000).toFixed(0)}mm</b><br/>
            ì°½ë©´ì (ì´): <b>${win.toFixed(2)}ã¡</b> (4ë©´ ìë™ ë¶„ë°°)
          </div>
        `;

        const row = document.createElement('div');
        row.className = 'wallRow';

        let anyInvalid = false;

        wallAreas.forEach((winfo, i)=>{
          const { svg, invalid } = wallSVG(winfo.w, r.h, alloc[i], color, `${winfo.key}ë©´`);
          anyInvalid = anyInvalid || invalid;

          const box = document.createElement('div');
          box.className = 'wallBox';
          box.innerHTML = `
            <div class="wallLabel">${winfo.key}ë©´ Â· í­ ${winfo.w}m Â· ë†’ì´ ${r.h}m</div>
            <div class="wallSvgWrap">${svg}</div>
            <div style="margin-top:6px;font-size:12px;color:#666;">
              ë²½ë©´ì  ${winfo.area.toFixed(2)}ã¡ Â· ì°½(ë¶„ë°°) ${alloc[i].toFixed(2)}ã¡
            </div>
          `;
          row.appendChild(box);
        });

        card.appendChild(row);

        const note = document.createElement('div');
        note.className = anyInvalid ? 'warn' : 'good';
        note.textContent = anyInvalid
          ? 'âš  ì–´ë–¤ ë©´ì€ ì°½ë©´ì ì´ ë²½ë©´ì ë³´ë‹¤ ì»¤ìš”. ì…ë ¥(ì°½ë©´ì ) í™•ì¸!'
          : 'âœ“ ì°½ë©´ì /ë²½ë©´ì  ë¹„ìœ¨ì´ ì •ìƒ ë²”ìœ„ë¡œ ë³´ì…ë‹ˆë‹¤.';
        card.appendChild(note);

        grid.appendChild(card);
      });
    }

    // -----------------------------
    // 5) 3D
    // -----------------------------
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf2f2f2);

    const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(12, 12, 16);
    camera.lookAt(0,0,0);

    const renderer = new THREE.WebGLRenderer({ antialias:true, preserveDrawingBuffer:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    threeEl.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.75));
    const dir = new THREE.DirectionalLight(0xffffff, 0.85);
    dir.position.set(50, 80, 50);
    dir.castShadow = true;
    scene.add(dir);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    scene.add(new THREE.GridHelper(100,100,0xbbbbbb,0xeeeeee));

    let pieces = [], ghosts = [], hitMeshes = [], labels3D = [];
    let labelsVisible = true, ghostsVisible = true;
    let shiftDown = false;

    const raycaster = new THREE.Raycaster();
    const dragPlane = new THREE.Plane(new THREE.Vector3(0,1,0), 0);
    const dragOffset = new THREE.Vector3();
    let dragging = false;
    let draggedGroup = null;

    function makeLabelSprite(text1, text2){
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.font = 'bold 40px Malgun Gothic';
      const w = ctx.measureText(text1).width + 70;
      canvas.width = Math.max(220, w);
      canvas.height = 120;
      ctx.fillStyle = 'rgba(255,255,255,0.88)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.strokeStyle = '#111827';
      ctx.lineWidth = 5;
      ctx.strokeRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#111';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.font = 'bold 38px Malgun Gothic';
      ctx.fillText(text1, canvas.width/2, 42);
      ctx.font = '26px Malgun Gothic';
      ctx.fillText(text2, canvas.width/2, 86);

      const tex = new THREE.CanvasTexture(canvas);
      const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex, transparent:true }));
      sprite.scale.set(canvas.width/20, 6, 1);
      return sprite;
    }

    function addWindowPatch(group, w, h, depth, wallT, winArea){
      if (!winArea || winArea <= 0) return;
      const wallAreaFront = w * h;
      const invalid = winArea > wallAreaFront * 0.98;

      const aspect = 1.6;
      let patchW = Math.sqrt(winArea * aspect);
      let patchH = winArea / patchW;

      patchW = Math.min(patchW, w * 0.9);
      patchH = Math.min(patchH, h * 0.8);

      const mat = new THREE.MeshBasicMaterial({
        color: invalid ? 0xff4d4d : 0x66ccff,
        transparent: true,
        opacity: invalid ? 0.45 : 0.32,
        side: THREE.DoubleSide
      });
      const geo = new THREE.PlaneGeometry(patchW, patchH);
      const mesh = new THREE.Mesh(geo, mat);

      // ë‚´ë¶€ë©´(ì‹¤ë‚´ì¸¡) ì „ë©´ë²½ì— ë¶™ì´ê¸°: z = -depth/2 + epsilon
      mesh.position.set(0, h*0.58, -(depth/2) + 0.002);
      group.add(mesh);

      const edge = new THREE.LineSegments(
        new THREE.EdgesGeometry(geo),
        new THREE.LineBasicMaterial({ color: invalid ? 0x7f0000 : 0x0b4aa2 })
      );
      edge.position.copy(mesh.position);
      group.add(edge);

      group.userData.windowInvalid = invalid;
    }

    function create3DRoom(d, colorHex, wallT){
      const group = new THREE.Group();
      const w = d.w, depth = d.d, h = d.h;
      const t = wallT;

      const matColor = new THREE.Color(colorHex);

      // ë°”ë‹¥(ìˆœë©´ì  ê¸°ì¤€)
      const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(w, depth),
        new THREE.MeshStandardMaterial({ color: matColor, side: THREE.DoubleSide })
      );
      floor.rotation.x = -Math.PI/2;
      floor.position.y = 0.01;
      floor.receiveShadow = true;
      group.add(floor);

      // ë²½ì€ ë°”ë‹¥ ì™¸ê³½ì— â€œë°”ê¹¥ìª½ìœ¼ë¡œâ€ ë‘ê»˜ê°€ ìƒê¸°ë„ë¡ ë°°ì¹˜
      const wallMat = new THREE.MeshStandardMaterial({ color: matColor, roughness:0.75, transparent:true, opacity:0.88 });

      // ì•/ë’¤ ë²½: í­ = w + 2t, ë‘ê»˜ = t
      const front = new THREE.Mesh(new THREE.BoxGeometry(w + 2*t, h, t), wallMat);
      front.position.set(0, h/2, -(depth/2 + t/2));
      group.add(front);

      const back = front.clone();
      back.position.set(0, h/2, +(depth/2 + t/2));
      group.add(back);

      // ì¢Œ/ìš° ë²½: ê¸¸ì´(ê¹Šì´) = depth + 2t, ë‘ê»˜ = t
      const side = new THREE.Mesh(new THREE.BoxGeometry(t, h, depth + 2*t), wallMat);
      side.position.set(-(w/2 + t/2), h/2, 0);
      group.add(side);

      const side2 = side.clone();
      side2.position.set(+(w/2 + t/2), h/2, 0);
      group.add(side2);

      // ì°½ íŒ¨ì¹˜(ì´ˆë³´ìš©: ì´ ì°½ë©´ì ì„ ì „ë©´ì— í‘œì‹œ)
      addWindowPatch(group, w, h, depth, t, d.winArea);

      const label = makeLabelSprite(d.name, `(${d.w}Ã—${d.d}Ã—${d.h}m)`);
      label.position.set(0, h + 2.2, 0);
      label.visible = labelsVisible;
      group.add(label);
      labels3D.push(label);

      // ë“œë˜ê·¸ íˆíŠ¸ ì˜ì—­(ë°”ë‹¥ë©´)
      const hit = new THREE.Mesh(
        new THREE.PlaneGeometry(w, depth),
        new THREE.MeshBasicMaterial({ visible:false })
      );
      hit.rotation.x = -Math.PI/2;
      hit.position.y = 0.12;
      hit.userData.parentGroup = group;
      group.add(hit);
      hitMeshes.push(hit);

      // ì§€í‘œ ê³„ì‚°
      const floorNet = w * depth;
      const floorGrossEst = (w + 2*t) * (depth + 2*t);
      const periInner = (w + depth) * 2;
      const periOuter = ((w + 2*t) + (depth + 2*t)) * 2;
      const wallAreaInner = periInner * h;
      const wallAreaOuter = periOuter * h;
      const winA = d.winArea || 0;
      const wallNetInner = Math.max(0, wallAreaInner - winA);
      const wallVolEst = periOuter * t * h;

      group.userData = {
        id: d.id,
        name: d.name,
        w, d: depth, h,
        wallT: t,
        winArea: winA,
        metrics: {
          floorNet, floorGrossEst,
          periInner, periOuter,
          wallAreaInner, wallAreaOuter,
          wallNetInner,
          wallVolEst
        },
        targetPos: new THREE.Vector3(),
        windowInvalid: false
      };

      return group;
    }

    function build3D(){
      pieces.forEach(p => scene.remove(p));
      ghosts.forEach(g => scene.remove(g));
      pieces = []; ghosts = []; hitMeshes = []; labels3D = [];
      tooltip.style.display = 'none';

      const t = globalWallThicknessM;

      let x=0, z=0, rowH=0;
      const LIMIT = 25;

      globalData.forEach(d=>{
        const color = EXCEL_COLORS[(d.id-1) % EXCEL_COLORS.length] || "#ccc";
        const g = create3DRoom(d, color, t);

        if (x + d.w > LIMIT){ x=0; z += rowH + 0.6; rowH=0; }

        g.userData.targetPos.set(x + d.w/2, 0, z + d.d/2);
        x += d.w + 0.6;
        rowH = Math.max(rowH, d.d);

        const ghost = new THREE.Mesh(
          new THREE.PlaneGeometry(d.w, d.d),
          new THREE.MeshBasicMaterial({ color:0x111111, transparent:true, opacity:0.14, side:THREE.DoubleSide })
        );
        ghost.rotation.x = -Math.PI/2;
        ghost.position.copy(g.userData.targetPos);
        ghost.position.y = 0.005;
        ghost.visible = ghostsVisible;
        scene.add(ghost);
        ghosts.push(ghost);

        g.position.set(g.userData.targetPos.x + (Math.random()-0.5)*15, 0, g.userData.targetPos.z + 8 + Math.random()*8);
        scene.add(g);
        pieces.push(g);
      });
    }

    // -----------------------------
    // 6) ëª¨ë“œ ìŠ¤ìœ„ì¹˜
    // -----------------------------
    function switchMode(next){
      if (mode === '2d') save2DPositions();
      mode = next;

      $('mode2d').classList.toggle('active', mode==='2d');
      $('mode3d').classList.toggle('active', mode==='3d');
      $('modeElev').classList.toggle('active', mode==='elev');

      twod.style.display = (mode==='2d') ? 'block' : 'none';
      threeEl.style.display = (mode==='3d') ? 'block' : 'none';
      elev.style.display = (mode==='elev') ? 'block' : 'none';
      tooltip.style.display = 'none';

      if (globalData.length){
        if (mode==='2d') build2D();
        else if (mode==='3d') build3D();
        else buildElevation();
      }

      renderer.setSize(window.innerWidth, window.innerHeight);
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
    }

    $('mode2d').addEventListener('click', ()=>switchMode('2d'));
    $('mode3d').addEventListener('click', ()=>switchMode('3d'));
    $('modeElev').addEventListener('click', ()=>switchMode('elev'));

    // -----------------------------
    // 7) ë²„íŠ¼ë“¤
    // -----------------------------
    $('resetBtn').addEventListener('click', ()=>{
      if (confirm('ì´ˆê¸°í™”í• ê¹Œìš”? (ì…ë ¥/ë„í˜• ëª¨ë‘ ì‚­ì œ)')){
        hardReset({ clearInput:true });
      }
    });

    $('clearInputBtn').addEventListener('click', ()=>{ inputEl.value=''; });

    $('sampleBtn').addEventListener('click', ()=>{
      inputEl.value =
`ê³µê°„ID\tê³µê°„ëª…\tê°€ë¡œ(m)\tì„¸ë¡œ(m)\të²½ë†’ì´(m)\tì°½ë©´ì (ã¡)
1\tê±°ì‹¤\t5.3\t2.4\t2.3\t3.2
2\të°©1\t2.4\t2.4\t2.3\t0
3\të°©2\t3.8\t5.45\t2.3\t1.5
4\të³µë„1\t1.55\t5.55\t2.3\t0
5\të°©3\t2.45\t5.55\t2.3\t2.0`;
      setStatus(`<b>ìƒíƒœ</b><br/>ìƒ˜í”Œ ì…ë ¥ ì™„ë£Œ. ì´ì œ <b>[ë„ë©´ ìƒì„±]</b>ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.`);
    });

    $('pasteBtn').addEventListener('click', async ()=>{
      try{
        const t = await navigator.clipboard.readText();
        if (!t) { alert('í´ë¦½ë³´ë“œì— í…ìŠ¤íŠ¸ê°€ ì—†ì–´ìš”.'); return; }
        inputEl.value = t;
        setStatus(`<b>ìƒíƒœ</b><br/><span class="ok">í´ë¦½ë³´ë“œ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!</span> ì´ì œ <b>[ë„ë©´ ìƒì„±]</b> ëˆ„ë¥´ì„¸ìš”.`);
      }catch(e){
        alert('í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ ì°¨ë‹¨ëì–´ìš”. ì§ì ‘ ë¶™ì—¬ë„£ê¸°(Ctrl+V)ë¡œ í•´ì£¼ì„¸ìš”.');
      }
    });

    $('buildBtn').addEventListener('click', ()=>{
      const t = getGlobalThickness(); // ë²½ë‘ê»˜ í™•ì •
      const { parsed, skipped } = parseText(inputEl.value || '');
      if (!parsed.length){
        setStatus(`<b>ìƒíƒœ</b><br/><span class="bad">ì¸ì‹ëœ ë°©ì´ 0ê°œ</span>ì…ë‹ˆë‹¤. í‘œë¥¼ í†µì§¸ë¡œ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê³  ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
        return;
      }
      globalData = parsed;

      const totalFloorNet = globalData.reduce((s,r)=>s + (r.w*r.d), 0);
      const totalFloorGrossEst = globalData.reduce((s,r)=>s + ((r.w+2*t)*(r.d+2*t)), 0);
      const totalWallInner = globalData.reduce((s,r)=>s + ((r.w+r.d)*2*r.h), 0);
      const totalWallOuter = globalData.reduce((s,r)=>s + (((r.w+2*t)+(r.d+2*t))*2*r.h), 0);
      const totalWin = globalData.reduce((s,r)=>s + (r.winArea||0), 0);
      const totalWallNetInner = Math.max(0, totalWallInner - totalWin);
      const totalWallVolEst = globalData.reduce((s,r)=>{
        const periOuter = ((r.w+2*t)+(r.d+2*t))*2;
        return s + (periOuter * t * r.h);
      }, 0);

      setStatus(
        `<b>ìƒíƒœ</b><br/>
         ë²½ë‘ê»˜: <b>${(t*1000).toFixed(0)}mm</b><br/>
         ë°© <b>${globalData.length}</b>ê°œ ì¸ì‹ / ê±´ë„ˆëœ€ <b>${skipped}</b>ì¤„<br/>
         ìˆœë©´ì (ì—‘ì…€ ë™ì¼): <b>${totalFloorNet.toFixed(2)}ã¡</b><br/>
         ë²½ í¬í•¨ ì¶”ì •(ì°¸ê³ ): <b>${totalFloorGrossEst.toFixed(2)}ã¡</b><br/>
         ë²½ë©´ì (ë‚´ì¸¡): <b>${totalWallInner.toFixed(2)}ã¡</b> / ì°½: <b>${totalWin.toFixed(2)}ã¡</b> / ì‹œê³µë©´ì (ë‚´ì¸¡-ì°½): <b>${totalWallNetInner.toFixed(2)}ã¡</b><br/>
         ë²½ë©´ì (ì™¸ì¸¡ ì¶”ì •): <b>${totalWallOuter.toFixed(2)}ã¡</b> / ë²½ì²´ë¶€í”¼(ì¶”ì •): <b>${totalWallVolEst.toFixed(2)}ã¥</b><br/>
         <span class="hint">â€» â€œë²½ í¬í•¨ ì¶”ì •ë©´ì â€ì€ ë°©ë³„ ìµœëŒ€ì¹˜ ê°œë…ì´ë¼ ê³µìœ ë²½ì´ ìˆìœ¼ë©´ ì¤‘ë³µë  ìˆ˜ ìˆì–´ìš”.</span>`
      );

      if (mode==='2d') build2D();
      else if (mode==='3d') build3D();
      else buildElevation();
    });

    // JSON ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°(ë¡œì»¬)
    $('jsonSaveBtn').addEventListener('click', ()=>{
      const t = getGlobalThickness();
      if (!globalData.length){
        const { parsed } = parseText(inputEl.value || '');
        if (!parsed.length){ alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ì–´ìš”. ë¨¼ì € ë¶™ì—¬ë„£ê³  ë„ë©´ ìƒì„±í•˜ì„¸ìš”.'); return; }
        globalData = parsed;
      }
      const payload = {
        app: "yugy.site",
        name: "ëš±ëšœë£¨ ë„ë©´ì†Œìƒìˆ  ë°©ëª©ë¡",
        version: "2.32",
        savedAt: new Date().toISOString(),
        wallThicknessMm: Math.round(t*1000),
        rooms: globalData
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ddungdduru_rooms.json';
      a.click();
      URL.revokeObjectURL(url);
      alert('JSON ì €ì¥ ì™„ë£Œ! (ë‹¤ìš´ë¡œë“œ í´ë” í™•ì¸)');
    });

    $('jsonLoadBtn').addEventListener('click', ()=> $('jsonFile').click());
    $('jsonFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      try{
        const text = await f.text();
        const obj = JSON.parse(text);
        const rooms = obj.rooms || obj.data || [];
        if (!Array.isArray(rooms) || !rooms.length) throw new Error('rooms ì—†ìŒ');

        // ë²½ë‘ê»˜ ë³µì›
        const wt = obj.wallThicknessMm;
        if (isFinite(wt) && wt > 0){
          $('wallThk').value = String(wt);
        }

        const lines = [];
        lines.push("ê³µê°„ID\tê³µê°„ëª…\tê°€ë¡œ(m)\tì„¸ë¡œ(m)\të²½ë†’ì´(m)\tì°½ë©´ì (ã¡)");
        rooms.forEach((r,i)=>{
          const id = r.id ?? (i+1);
          const name = r.name ?? '';
          const w = r.w ?? 0;
          const d = r.d ?? r.depth ?? 0;
          const h = r.h ?? 2.3;
          const wa = r.winArea ?? 0;
          lines.push(`${id}\t${name}\t${w}\t${d}\t${h}\t${wa}`);
        });
        inputEl.value = lines.join('\n');

        const parsed = parseText(inputEl.value).parsed;
        globalData = parsed;

        getGlobalThickness();

        if (mode==='2d') build2D();
        else if (mode==='3d') build3D();
        else buildElevation();

        setStatus(`<b>ìƒíƒœ</b><br/><span class="ok">JSON ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!</span> ë°© ${globalData.length}ê°œ.`);
      }catch(err){
        alert('JSON í˜•ì‹ì´ ë§ì§€ ì•Šì•„ìš”. (ì´ ì‚¬ì´íŠ¸ì—ì„œ ì €ì¥í•œ JSONì„ ì˜¬ë ¤ì£¼ì„¸ìš”)');
      }finally{
        e.target.value = '';
      }
    });

    // -----------------------------
    // 8) 3D ì¸í„°ë™ì…˜/íˆ´íŒ/ë“œë˜ê·¸
    // -----------------------------
    function getMouse(e){
      const rect = renderer.domElement.getBoundingClientRect();
      return {
        x: ((e.clientX - rect.left)/rect.width) * 2 - 1,
        y: -(((e.clientY - rect.top)/rect.height) * 2 - 1)
      };
    }

    threeEl.addEventListener('pointerdown', (e)=>{
      if (mode!=='3d' || !shiftDown) return;
      const m = getMouse(e);
      raycaster.setFromCamera(m, camera);
      const hits = raycaster.intersectObjects(hitMeshes);
      if (hits.length){
        dragging = true;
        draggedGroup = hits[0].object.userData.parentGroup;
        controls.enabled = false;
        tooltip.style.display = 'none';
        renderer.domElement.style.cursor = 'grabbing';
        raycaster.ray.intersectPlane(dragPlane, dragOffset);
        dragOffset.sub(draggedGroup.position);
      }
    });

    threeEl.addEventListener('pointermove', (e)=>{
      if (mode!=='3d') return;

      const m = getMouse(e);
      raycaster.setFromCamera(m, camera);

      if (dragging && draggedGroup){
        const p = new THREE.Vector3();
        raycaster.ray.intersectPlane(dragPlane, p);
        draggedGroup.position.copy(p.sub(dragOffset));
        return;
      }

      const hits = raycaster.intersectObjects(hitMeshes);
      if (shiftDown && hits.length) renderer.domElement.style.cursor = 'grab';
      else renderer.domElement.style.cursor = 'auto';

      if (hits.length){
        const u = hits[0].object.userData.parentGroup.userData;
        tooltip.innerHTML =
          `<b>${u.name}</b>
           <div class="ttRow"><span class="ttLbl">ì¹˜ìˆ˜</span><span class="ttVal">${u.w}Ã—${u.d}Ã—${u.h} m</span></div>
           <div class="ttRow"><span class="ttLbl">ë²½ë‘ê»˜</span><span class="ttVal">${(u.wallT*1000).toFixed(0)} mm</span></div>
           <div class="ttRow"><span class="ttLbl">ë°”ë‹¥(ìˆœ)</span><span class="ttVal">${u.metrics.floorNet.toFixed(2)} ã¡</span></div>
           <div class="ttRow"><span class="ttLbl">ë°”ë‹¥(ë²½í¬í•¨ ì¶”ì •)</span><span class="ttVal">${u.metrics.floorGrossEst.toFixed(2)} ã¡</span></div>
           <div class="ttRow"><span class="ttLbl">ë‘˜ë ˆ(ë‚´ì¸¡)</span><span class="ttVal">${u.metrics.periInner.toFixed(2)} m</span></div>
           <div class="ttRow"><span class="ttLbl">ë²½ë©´ì (ë‚´ì¸¡)</span><span class="ttVal">${u.metrics.wallAreaInner.toFixed(2)} ã¡</span></div>
           <div class="ttRow"><span class="ttLbl">ì°½ë©´ì </span><span class="ttVal">${(u.winArea||0).toFixed(2)} ã¡</span></div>
           <div class="ttRow"><span class="ttLbl">ì‹œê³µë©´ì (ë‚´ì¸¡-ì°½)</span><span class="ttVal">${u.metrics.wallNetInner.toFixed(2)} ã¡</span></div>
           <div class="ttRow"><span class="ttLbl">ë²½ì²´ë¶€í”¼(ì¶”ì •)</span><span class="ttVal">${u.metrics.wallVolEst.toFixed(2)} ã¥</span></div>
          `;
        tooltip.style.display = 'block';
        tooltip.style.left = (e.clientX + 14) + 'px';
        tooltip.style.top  = (e.clientY + 14) + 'px';
      }else{
        tooltip.style.display = 'none';
      }
    });

    function endDrag(){
      if (dragging && draggedGroup){
        const t = draggedGroup.userData.targetPos;
        if (draggedGroup.position.distanceTo(t) < 0.5) draggedGroup.position.copy(t);
      }
      dragging = false;
      draggedGroup = null;
      controls.enabled = true;
      renderer.domElement.style.cursor = shiftDown ? 'grab' : 'auto';
    }
    threeEl.addEventListener('pointerup', endDrag);
    threeEl.addEventListener('pointerleave', endDrag);

    // -----------------------------
    // 9) ë‹¨ì¶•í‚¤: P ìº¡ì²˜
    // -----------------------------
    window.addEventListener('keydown', (e)=>{
      const k = e.key.toLowerCase();
      if (k==='shift') shiftDown = true;

      if (k==='p'){
        if (mode==='2d'){
          html2canvas(twod).then((c)=>{
            const a = document.createElement('a');
            a.download = '2D_Plan.png';
            a.href = c.toDataURL('image/png');
            a.click();
          });
        } else if (mode==='elev'){
          html2canvas(elev).then((c)=>{
            const a = document.createElement('a');
            a.download = 'Elevation.png';
            a.href = c.toDataURL('image/png');
            a.click();
          });
        } else {
          renderer.render(scene, camera);
          const a = document.createElement('a');
          a.download = '3D_View.png';
          a.href = renderer.domElement.toDataURL('image/png');
          a.click();
        }
      }

      if (mode==='3d'){
        if (k==='g'){ ghostsVisible = !ghostsVisible; ghosts.forEach(x=>x.visible=ghostsVisible); }
        if (k==='l'){ labelsVisible = !labelsVisible; labels3D.forEach(x=>x.visible=labelsVisible); }
      }
    });
    window.addEventListener('keyup', (e)=>{
      if (e.key === 'Shift'){
        shiftDown = false;
        renderer.domElement.style.cursor = 'auto';
      }
    });

    // -----------------------------
    // 10) ë¦¬ì‚¬ì´ì¦ˆ/ì• ë‹ˆë©”ì´ì…˜
    // -----------------------------
    window.addEventListener('resize', ()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      if (mode==='2d') build2D();
      if (mode==='elev') buildElevation();
    });

    function animate(){
      requestAnimationFrame(animate);
      if (mode==='3d'){
        controls.update();
        renderer.render(scene, camera);
      }
    }
    animate();

    // ì‹œì‘
    hardReset({ clearInput:true });
    getGlobalThickness();
    switchMode('3d');
  </script>
</body>
</html>
