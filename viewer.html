<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ëš±ëšœë£¨ì˜ ë„ë©´ì†Œìƒìˆ </title>

  <!-- âœ… Google tag (gtag.js) - GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-0WZRWTBSK6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-0WZRWTBSK6');
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* === ê¸°ë³¸ ìŠ¤íƒ€ì¼ === */
    body { margin: 0; overflow: hidden; font-family: 'Segoe UI', 'Malgun Gothic', sans-serif; background: #f0f0f0; user-select: none; }

    /* === UI íŒ¨ë„ === */
    #ui-container {
      position: absolute; top: 10px; left: 10px;
      background: rgba(255, 255, 255, 0.96);
      padding: 16px; border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      width: 360px; z-index: 100;
      max-height: 90vh; overflow-y: auto;
      border: 1px solid #ddd;
      display: flex; flex-direction: column; gap: 8px;
      transition: width 0.25s ease, padding 0.25s ease;
    }

    /* ìŠ¤í¬ë¡¤ë°” ê¾¸ë¯¸ê¸° */
    #ui-container::-webkit-scrollbar { width: 6px; }
    #ui-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

    .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    h3 { margin: 0; color: #333; font-size: 18px; display: flex; align-items: center; gap: 6px; }
    .badge { background: #333; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; vertical-align: middle; }

    .header-actions { display: flex; align-items: center; gap: 6px; }

    #collapseBtn {
      background: none; border: 1px solid #ccc; border-radius: 10px;
      padding: 4px 10px; font-size: 12px; cursor: pointer;
      display: flex; align-items: center; gap: 4px; transition: all 0.2s;
    }
    #collapseBtn:hover { background: #eee; border-color: #999; }

    #langBtn {
      background: none; border: 1px solid #ccc; border-radius: 20px;
      padding: 4px 10px; font-size: 12px; cursor: pointer;
      display: flex; align-items: center; gap: 4px; transition: all 0.2s;
    }
    #langBtn:hover { background: #eee; border-color: #999; }

    .tab-container { display: flex; gap: 5px; margin-bottom: 4px; }
    .tab-btn {
      flex: 1; padding: 8px; border: none; border-radius: 6px;
      cursor: pointer; font-weight: bold; font-size: 13px; transition: all 0.2s;
    }
    .tab-btn.active { background: #333; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .tab-btn.inactive { background: #e0e0e0; color: #777; }
    .tab-btn.inactive:hover { background: #d0d0d0; }

    /* ë§í¬ ë²„íŠ¼ ê·¸ë£¹ */
    .link-group { display: flex; gap: 5px; margin-bottom: 5px; }
    .link-btn {
        flex: 1; padding: 10px; font-size: 12px; text-decoration: none; color: #333;
        border: 1px solid #ccc; border-radius: 6px; text-align: center; background: #fff;
        transition: background 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; font-weight: bold;
    }
    .link-btn:hover { background: #f5f5f5; border-color: #999; }

    textarea { width: 100%; height: 100px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; padding: 5px; box-sizing: border-box; resize: vertical; user-select: text; }

    #buildBtn {
      width: 100%; padding: 12px; background: #007bff; color: white;
      border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; margin-top: 5px;
    }
    #buildBtn:hover { background: #0056b3; }

    /* === [NEW] 2D ì¹˜ìˆ˜ ì»¨íŠ¸ë¡¤ === */
    #dimControls{
      display: none;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 2px;
    }
    .dim-btn{
      flex: 1;
      min-width: 48%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      transition: all 0.15s;
    }
    .dim-btn:hover{ background:#f5f5f5; border-color:#999; }
    .dim-btn.on{
      background:#111;
      color:#fff;
      border-color:#111;
    }
    .dim-btn.warn{
      background:#fff4f4;
      border-color:#f2b3b3;
      color:#8a1f1f;
    }
    .dim-btn.warn:hover{
      background:#ffecec;
      border-color:#e38b8b;
    }
    #dimHint{
      display: none;
      font-size: 11px;
      color: #555;
      line-height: 1.5;
      background: #f7f7f7;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e7e7e7;
    }
    #dimHint b{ color:#111; }

    /* === ì‚¬ìš©ë²•: ë¸”ë¡œê·¸ + ìœ íŠœë¸Œ ë²„íŠ¼(ë‚˜ë€íˆ) === */
    #guideRow{
      display:flex;
      gap:6px;
      margin-top: 2px;
    }
    .guide-btn{
      flex: 1;
      padding: 10px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      font-size: 13px;
      text-align: center;
      border: 1px solid #e2d3b1;
      background: #fff7e6;
      color: #6b4e00;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-sizing: border-box;
      white-space: nowrap;
    }
    .guide-btn:hover{
      background: #ffe9bf;
      border-color: #caa86a;
      transform: translateY(-1px);
    }

    #info { font-size: 12px; color: #555; line-height: 1.4; background: #f9f9f9; padding: 10px; border-radius: 6px; margin-top: 5px;}
    kbd { background:#fff; border:1px solid #ccc; padding:1px 5px; border-radius:4px; font-family: monospace; font-weight: bold;}
    .caution { color: #d9534f; font-weight: bold; }

    /* === [NEW] íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸° === */
    #ui-container.collapsed{
      width: 52px;
      padding: 10px 6px;
      overflow: hidden;
    }
    #ui-container.collapsed .tab-container,
    #ui-container.collapsed .link-group,
    #ui-container.collapsed #hintText,
    #ui-container.collapsed #dataInput,
    #ui-container.collapsed #buildBtn,
    #ui-container.collapsed #dimControls,
    #ui-container.collapsed #dimHint,
    #ui-container.collapsed #guideRow,
    #ui-container.collapsed #info,
    #ui-container.collapsed .family-section{
      display: none !important;
    }
    #ui-container.collapsed #appTitle{ display: none !important; }
    #ui-container.collapsed #langBtn{ display: none !important; }
    #ui-container.collapsed .header-row{ justify-content: center; }
    #ui-container.collapsed #collapseBtn{ width: 100%; justify-content: center; }

    /* === [NEW] í•˜ë‹¨ íŒ¨ë°€ë¦¬ ì‚¬ì´íŠ¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ === */
    .family-section {
        margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;
        display: flex; flex-direction: column; gap: 5px;
    }
    .family-btn {
        display: flex; align-items: center; justify-content: center;
        width: 100%; padding: 10px; border-radius: 6px; text-decoration: none;
        font-weight: bold; font-size: 13px; box-sizing: border-box;
        transition: all 0.2s;
    }
    /* í†¡í†¡ ë²„íŠ¼ */
    .btn-talk { background: #03C75A; color: white; border: none; box-shadow: 0 2px 5px rgba(3,199,90,0.3); }
    .btn-talk:hover { background: #02b351; transform: translateY(-1px); }

    /* íŒ¨ë°€ë¦¬ ë²„íŠ¼ ê³µí†µ */
    .btn-site { background: white; border: 1px solid #ddd; color: #333; }
    .btn-site:hover { background: #f5f5f5; border-color: #bbb; }

    /* ê·¸ë¦°ë¦¬ëª¨ë¸ë§ ê°•ì¡° */
    .btn-store { background: #2c3e50; color: white; border: none; }
    .btn-store:hover { background: #1a252f; }

    /* === íˆ´íŒ ìŠ¤íƒ€ì¼ === */
    #tooltip {
      position: fixed; z-index: 9999; display: none; pointer-events: none;
      background: rgba(20, 20, 20, 0.95); color: #fff;
      padding: 12px 16px; border-radius: 8px;
      font-size: 13px; line-height: 1.6;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1);
      min-width: 200px;
    }
    #tooltip b { font-size: 15px; color: #ffd700; display: block; margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 4px;}
    #tooltip .row { display: flex; justify-content: space-between; gap: 15px; }
    #tooltip .val { font-weight: bold; color: #fff; }
    #tooltip .lbl { color: #aaa; }

    /* === ë·°ì–´ ì˜ì—­ === */
    #viewer-area { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
    #three-container { width: 100%; height: 100%; display: block; cursor: auto; }

    #twod-container {
      width: 100%; height: 100%; overflow: auto; display: none;
      background: #fff; position: relative;
      background-image: linear-gradient(#eee 1px, transparent 1px), linear-gradient(90deg, #eee 1px, transparent 1px);
      background-size: 40px 40px;
    }
    .room-2d {
      position: absolute; border: 2px solid #666;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-size: 12px; color: #000; cursor: grab; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
      touch-action: none;
    }
    .room-2d.dragging { cursor: grabbing; opacity: 0.8; z-index: 999; box-shadow: 4px 4px 10px rgba(0,0,0,0.2); }
    .wall-section-title {
        position: absolute; font-weight: bold; font-size: 18px; color: #333; padding: 10px;
        border-bottom: 2px solid #333; width: auto; left: 400px; right: 20px;
    }
    .wall-section-title.unfolding { left: 20px; width: 90%; }

    /* === [NEW] 2D ì¹˜ìˆ˜ SVG ì˜¤ë²„ë ˆì´ === */
    #dimLayer2d{
      position: absolute;
      left: 0; top: 0;
      z-index: 1200;
      pointer-events: none; /* ê¸°ë³¸: ë°© ë“œë˜ê·¸ ë°©í•´ ì•ˆí•¨ */
    }
    #dimLayer2d.is-hidden{ display:none; }
    #dimLayer2d.dim-mode{
      pointer-events: auto; /* ì¹˜ìˆ˜ ì¶”ê°€ ëª¨ë“œ: í´ë¦­ ë°›ìŒ */
      cursor: crosshair;
    }
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>

<body>

  <div id="tooltip"></div>

  <div id="ui-container">
    <div class="header-row">
      <h3 id="appTitle">ëš±ëšœë£¨ì˜ ë„ë©´ì†Œìƒìˆ  <span class="badge">v2.15</span></h3>

      <div class="header-actions">
        <button id="collapseBtn" title="ì ‘ê¸°">â´</button>
        <button id="langBtn">ğŸŒ English</button>
      </div>
    </div>

    <div class="tab-container">
      <button id="tab2D" class="tab-btn inactive">ğŸ“Š ì—‘ì…€ í‚¤íŠ¸(2D)</button>
      <button id="tab3D" class="tab-btn active">ğŸ§Š 3D íˆ¬ì‹œë„</button>
    </div>

    <div class="link-group">
        <a href="https://drive.google.com/file/d/112Y3BEiE_1ooNrF5tPZd6SnDRHyXcrDg/view?usp=sharing" target="_blank" class="link-btn" rel="noopener">
            ğŸ“‚ ì—‘ì…€í‚¤íŠ¸ ë‹¤ìš´
        </a>
        <a href="https://docs.google.com/spreadsheets/d/1GW5nJHgax0XTXOPyyVusVr_WKob3S5URJG1lSiAM6bE/copy" target="_blank" class="link-btn" rel="noopener">
            ğŸ“‘ êµ¬ê¸€ì‹œíŠ¸ ì‚¬ë³¸ ë‹¤ìš´
        </a>
    </div>

    <div id="hintText" class="hint" style="font-size:11px; color:#888;">ë°ì´í„°ë¥¼ ë³µì‚¬í•´ì„œ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</div>
    <textarea id="dataInput"></textarea>

    <button id="buildBtn">ğŸ—ï¸ ë„ë©´ ìƒì„±í•˜ê¸° (Build)</button>

    <!-- âœ… [NEW] 2D ì¹˜ìˆ˜ ë²„íŠ¼ë“¤ (2D ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) -->
    <div id="dimControls">
      <button id="dimToggleBtn" class="dim-btn">ğŸ“ ì¹˜ìˆ˜: OFF</button>
      <button id="dimModeBtn" class="dim-btn">âœï¸ ì¹˜ìˆ˜ ì¶”ê°€: OFF</button>
      <button id="dimClearBtn" class="dim-btn warn">ğŸ—‘ï¸ ì¹˜ìˆ˜ ì§€ìš°ê¸°</button>
    </div>
    <div id="dimHint"></div>

    <!-- âœ… ì‚¬ìš©ë²•: ë¸”ë¡œê·¸ + ìœ íŠœë¸Œ(ìš”ì²­ ë°˜ì˜) -->
    <div id="guideRow">
      <a id="blogGuideBtn" class="guide-btn" href="https://blog.naver.com/grenarch/224121422560" target="_blank" rel="noopener">
        ğŸ“˜ ì‚¬ìš©ë²• í•´ì„¤(ë¸”ë¡œê·¸)
      </a>
      <a id="youtubeGuideBtn" class="guide-btn" href="https://youtu.be/8Gu9_nKxKp0?si=febt9ji6ybPsZF7O" target="_blank" rel="noopener">
        â–¶ï¸ ì‚¬ìš©ë²• ì˜ìƒ(ìœ íŠœë¸Œ)
      </a>
    </div>

    <div id="info">
      <div id="cautionText" class="caution" style="margin-bottom: 8px;">â€» ìƒˆë¡œê³ ì¹¨(F5)í•˜ë©´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤!</div>
      <div id="info-2d" style="display:none;">
        <b id="info2dTitle">[2D ëª¨ë“œ ì•ˆë‚´]</b><br/>
        <span id="info2dDrag">âœ… <kbd>í´ë¦­+ë“œë˜ê·¸</kbd>: ë°© ì¡°ê° ì´ë™</span><br/>
        <span id="info2dScroll">âœ… ë§ˆìš°ìŠ¤ íœ : í™”ë©´ ìŠ¤í¬ë¡¤</span><br/>
        <span id="info2dCapture">âœ… <kbd>P</kbd>: í™”ë©´ ìº¡ì²˜(ì €ì¥) ğŸ“¸</span><br/>
      </div>
      <div id="info-3d">
        <b id="info3dTitle">[3D ëª¨ë“œ ì•ˆë‚´]</b><br/>
        <span id="info3dShift">âœ… <kbd>Shift</kbd> + ë“œë˜ê·¸: ë°© ì´ë™</span><br/>
        <span id="info3dMouse">âœ… ì¢Œí´ë¦­: íšŒì „ / ìš°í´ë¦­: ì´ë™</span><br/>
        <span id="info3dLabel">âœ… <kbd>L</kbd>: ê¸€ì”¨(ë¼ë²¨) ë„ê¸°/ì¼œê¸° âœ¨</span><br/>
        <span id="info3dCapture">âœ… <kbd>P</kbd>: í™”ë©´ ìº¡ì²˜(ì €ì¥) ğŸ“¸</span><br/>
        <span id="info3dGhost">âœ… <kbd>G</kbd>: ì •ë‹µ ìœ ë ¹ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°</span>
      </div>
    </div>

    <div class="family-section">
        <a href="https://talk.naver.com/W4HB1I" target="_blank" class="family-btn btn-talk" rel="noopener">
            ğŸ’¬ ëš±ëšœë£¨ ê±´ì¶•ì‚¬ì™€ í†¡í†¡ ìƒë‹´í•˜ê¸°
        </a>

        <div style="display:flex; gap:5px;">
            <a href="https://yugy.org" target="_blank" class="family-btn btn-site" rel="noopener">
                ğŸ  ê³µì‹í™ˆ (yugy.org)
            </a>
            <a href="https://yugy.cloud" target="_blank" class="family-btn btn-site" rel="noopener">
                â˜ï¸ ëª¨ë¸í•˜ìš°ìŠ¤
            </a>
        </div>

        <a href="https://yugy.store" target="_blank" class="family-btn btn-store" rel="noopener">
            ğŸŒ¿ ê·¸ë¦°ë¦¬ëª¨ë¸ë§ (yugy.store)
        </a>
    </div>

  </div>

  <div id="viewer-area">
    <div id="twod-container"></div>
    <div id="three-container"></div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // ==========================================
    // 0. ë‹¤êµ­ì–´ ì„¤ì •
    // ==========================================
    const TRANSLATIONS = {
      ko: {
        browserTitle: "ëš±ëšœë£¨ì˜ ë„ë©´ì†Œìƒìˆ ",
        title: "ëš±ëšœë£¨ì˜ ë„ë©´ì†Œìƒìˆ ",
        langBtn: "ğŸŒ English",
        collapseTitleCollapse: "ì ‘ê¸°",
        collapseTitleExpand: "í¼ì¹˜ê¸°",
        tab2d: "ğŸ“Š ì—‘ì…€ í‚¤íŠ¸(2D)", tab3d: "ğŸ§Š 3D íˆ¬ì‹œë„",
        hint: "ì—‘ì…€/êµ¬ê¸€ì‹œíŠ¸ ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.",
        placeholder: "ì˜ˆì‹œ ë°ì´í„°)\n1\tê±°ì‹¤\t5.0\t4.0\t...\n2\tì¹¨ì‹¤\t3.5\t3.0\t...",
        buildBtn: "ğŸ—ï¸ ë„ë©´ ìƒì„±í•˜ê¸° (Build)", caution: "â€» ìƒˆë¡œê³ ì¹¨(F5)í•˜ë©´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤!",
        // âœ… ì‚¬ìš©ë²• ë²„íŠ¼ í…ìŠ¤íŠ¸
        guideBlogBtn: "ğŸ“˜ ì‚¬ìš©ë²• í•´ì„¤(ë¸”ë¡œê·¸)",
        guideYoutubeBtn: "â–¶ï¸ ì‚¬ìš©ë²• ì˜ìƒ(ìœ íŠœë¸Œ)",
        info2d: { title: "[2D ëª¨ë“œ ì•ˆë‚´]", drag: "âœ… <kbd>í´ë¦­+ë“œë˜ê·¸</kbd>: ë°© ì¡°ê° ì´ë™", scroll: "âœ… ë§ˆìš°ìŠ¤ íœ : í™”ë©´ ìŠ¤í¬ë¡¤", capture: "âœ… <kbd>P</kbd>: í™”ë©´ ìº¡ì²˜(ì €ì¥) ğŸ“¸" },
        info3d: { title: "[3D ëª¨ë“œ ì•ˆë‚´]", shift: "âœ… <kbd>Shift</kbd> + ë“œë˜ê·¸: ë°© ì´ë™", mouse: "âœ… ì¢Œí´ë¦­: íšŒì „ / ìš°í´ë¦­: ì´ë™", label: "âœ… <kbd>L</kbd>: ê¸€ì”¨(ë¼ë²¨) ë„ê¸°/ì¼œê¸° âœ¨", capture: "âœ… <kbd>P</kbd>: í™”ë©´ ìº¡ì²˜(ì €ì¥) ğŸ“¸", ghost: "âœ… <kbd>G</kbd>: ì •ë‹µ ìœ ë ¹ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°" },
        section1: "1. ë°”ë‹¥ í‰ë©´ë„ (ë“œë˜ê·¸í•´ì„œ ë§ì¶°ë³´ì„¸ìš”!)", section2: "2. ë²½ì²´ ì „ê°œë„ (ê³ ì •ë¨)",
        wallLabels: ["ë²½-A(ì•)", "ë²½-B(ìš°)", "ë²½-C(ë’¤)", "ë²½-D(ì¢Œ)"],
        tooltip: { dim: "ì¹˜ìˆ˜", floor: "ë°”ë‹¥", ceil: "ì²œì¥", peri: "ë‘˜ë ˆ", wall: "ë²½ë©´ì " },

        dims: {
          toggleOn: "ğŸ“ ì¹˜ìˆ˜: ON",
          toggleOff: "ğŸ“ ì¹˜ìˆ˜: OFF",
          modeOn: "âœï¸ ì¹˜ìˆ˜ ì¶”ê°€: ON",
          modeOff: "âœï¸ ì¹˜ìˆ˜ ì¶”ê°€: OFF",
          clear: "ğŸ—‘ï¸ ì¹˜ìˆ˜ ì§€ìš°ê¸°",
          hint: "ì¹˜ìˆ˜ ì¶”ê°€ ëª¨ë“œì…ë‹ˆë‹¤. ë„ë©´ ìœ„ë¥¼ <b>ë‘ ë²ˆ í´ë¦­</b>í•˜ë©´ ì¹˜ìˆ˜ê°€ ìƒê²¨ìš”.<br/>âœ… <b>Shift</b>: ìˆ˜í‰/ìˆ˜ì§ ê³ ì • &nbsp;&nbsp;âœ… <b>Esc</b>: ëª¨ë“œ ì¢…ë£Œ<br/>âœ… <b>D</b>: ì¹˜ìˆ˜ í‘œì‹œ í† ê¸€ &nbsp;&nbsp;âœ… <b>M</b>: ì¹˜ìˆ˜ ì¶”ê°€ ëª¨ë“œ í† ê¸€<br/>âœ… <b>Shift+P</b>: (ì¹˜ìˆ˜ ìˆ¨ê¹€ì´ì–´ë„) ì¹˜ìˆ˜ í¬í•¨ ìº¡ì²˜"
        }
      },
      en: {
        browserTitle: "Ddungdduru's Blueprint Rescue",
        title: "Ddungdduru's Rescue",
        langBtn: "ğŸŒ í•œêµ­ì–´",
        collapseTitleCollapse: "Collapse",
        collapseTitleExpand: "Expand",
        tab2d: "ğŸ“Š 2D Plan Mode", tab3d: "ğŸ§Š 3D View Mode",
        hint: "Paste your Excel/Sheet data below.",
        placeholder: "Example Data)\n1\tLiving Room\t5.0\t4.0\t...\n2\tBedroom\t3.5\t3.0\t...",
        buildBtn: "ğŸ—ï¸ Generate Blueprint", caution: "â€» Refreshing(F5) will reset everything!",
        // âœ… usage buttons
        guideBlogBtn: "ğŸ“˜ How-to (Blog)",
        guideYoutubeBtn: "â–¶ï¸ How-to (YouTube)",
        info2d: { title: "[2D Mode Guide]", drag: "âœ… <kbd>Click+Drag</kbd>: Move Room", scroll: "âœ… Mouse Wheel: Scroll", capture: "âœ… <kbd>P</kbd>: Capture Screen ğŸ“¸" },
        info3d: { title: "[3D Mode Guide]", shift: "âœ… <kbd>Shift</kbd> + Drag: Move Room", mouse: "âœ… L-Click: Rotate / R-Click: Pan", label: "âœ… <kbd>L</kbd>: Toggle Labels âœ¨", capture: "âœ… <kbd>P</kbd>: Capture Screen ğŸ“¸", ghost: "âœ… <kbd>G</kbd>: Toggle Ghost Guide" },
        section1: "1. Floor Plan (Drag to arrange!)", section2: "2. Wall Unfolding (Fixed)",
        wallLabels: ["Wall-A(F)", "Wall-B(R)", "Wall-C(B)", "Wall-D(L)"],
        tooltip: { dim: "Dim", floor: "Floor", ceil: "Ceiling", peri: "Perim", wall: "Wall Area" },

        dims: {
          toggleOn: "ğŸ“ Dimensions: ON",
          toggleOff: "ğŸ“ Dimensions: OFF",
          modeOn: "âœï¸ Add Dim: ON",
          modeOff: "âœï¸ Add Dim: OFF",
          clear: "ğŸ—‘ï¸ Clear Dims",
          hint: "Dimension add mode. <b>Click twice</b> on the plan to create a dimension.<br/>âœ… <b>Shift</b>: lock horizontal/vertical &nbsp;&nbsp;âœ… <b>Esc</b>: exit mode<br/>âœ… <b>D</b>: toggle dimensions &nbsp;&nbsp;âœ… <b>M</b>: toggle add mode<br/>âœ… <b>Shift+P</b>: capture WITH dims even if hidden"
        }
      }
    };
    let currentLang = 'ko';

    // ==========================================
    // [NEW] íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸° ë¡œì§
    // ==========================================
    const uiContainer = document.getElementById('ui-container');
    const collapseBtn = document.getElementById('collapseBtn');
    let panelCollapsed = false;

    function applyCollapseBtnLabel() {
      const t = TRANSLATIONS[currentLang];
      collapseBtn.title = panelCollapsed ? t.collapseTitleExpand : t.collapseTitleCollapse;
      collapseBtn.innerText = panelCollapsed ? 'âµ' : 'â´';
    }

    function setPanelCollapsed(collapsed) {
      panelCollapsed = !!collapsed;
      uiContainer.classList.toggle('collapsed', panelCollapsed);
      localStorage.setItem('uiCollapsed', panelCollapsed ? '1' : '0');
      applyCollapseBtnLabel();
    }

    // ì´ˆê¸° ìƒíƒœ(ë¡œì»¬ ì €ì¥)
    const savedCollapsed = localStorage.getItem('uiCollapsed');
    if (savedCollapsed === '1') setPanelCollapsed(true);

    collapseBtn.addEventListener('click', () => setPanelCollapsed(!panelCollapsed));

    // ==========================================
    // 1. ë°ì´í„° ë° ìœ í‹¸ë¦¬í‹°
    // ==========================================
    const EXCEL_COLORS = [
      "#FFCCCC", "#FFE5CC", "#FFFFCC", "#E5FFCC", "#CCFFCC", "#CCFFE5", "#CCFFFF", "#CCE5FF", "#CCCCFF", "#E5CCFF",
      "#FFCCFF", "#FFCCE5", "#FFB2B2", "#FFD6A5", "#FFEF9F", "#CAE799", "#A6E3A1", "#99DDCC", "#9FDBFF", "#ADC1FF",
      "#C8B2FF", "#E0B2FF", "#FFB2F5", "#FFB2D7", "#FFB2B2", "#FF8282", "#FFAA64", "#FFD246", "#B4DC5A", "#78D296"
    ];
    let globalData = [];
    let currentMode = '3d';

    // [NEW] 2D ì¹˜ìˆ˜ UI ì—˜ë¦¬ë¨¼íŠ¸
    const dimControls = document.getElementById('dimControls');
    const dimToggleBtn = document.getElementById('dimToggleBtn');
    const dimModeBtn = document.getElementById('dimModeBtn');
    const dimClearBtn = document.getElementById('dimClearBtn');
    const dimHint = document.getElementById('dimHint');

    function setLanguage(lang) {
      currentLang = lang;
      const t = TRANSLATIONS[lang];
      document.title = t.browserTitle;
      document.getElementById('appTitle').innerHTML = `${t.title} <span class="badge">v2.15</span>`;
      document.getElementById('langBtn').innerText = t.langBtn;
      document.getElementById('tab2D').innerText = t.tab2d;
      document.getElementById('tab3D').innerText = t.tab3d;
      document.getElementById('hintText').innerText = t.hint;
      if (!document.getElementById('dataInput').value) document.getElementById('dataInput').placeholder = t.placeholder;
      document.getElementById('buildBtn').innerText = t.buildBtn;
      document.getElementById('cautionText').innerText = t.caution;

      // âœ… ì‚¬ìš©ë²• ë²„íŠ¼ í…ìŠ¤íŠ¸ ë‹¤êµ­ì–´
      document.getElementById('blogGuideBtn').innerText = t.guideBlogBtn;
      document.getElementById('youtubeGuideBtn').innerText = t.guideYoutubeBtn;

      // [NEW] ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ ë¼ë²¨/íˆ´íŒ ê°±ì‹ 
      applyCollapseBtnLabel();

      document.getElementById('info2dTitle').innerText = t.info2d.title;
      document.getElementById('info2dDrag').innerHTML = t.info2d.drag;
      document.getElementById('info2dScroll').innerText = t.info2d.scroll;
      document.getElementById('info2dCapture').innerHTML = t.info2d.capture;
      document.getElementById('info3dTitle').innerText = t.info3d.title;
      document.getElementById('info3dShift').innerHTML = t.info3d.shift;
      document.getElementById('info3dMouse').innerText = t.info3d.mouse;
      document.getElementById('info3dLabel').innerHTML = t.info3d.label;
      document.getElementById('info3dCapture').innerHTML = t.info3d.capture;
      document.getElementById('info3dGhost').innerHTML = t.info3d.ghost;

      // [NEW] ì¹˜ìˆ˜ íŒíŠ¸ ë¬¸êµ¬ ë‹¤êµ­ì–´
      dimHint.innerHTML = t.dims.hint;

      // ìƒíƒœì— ë§ê²Œ UI ê°±ì‹ 
      updateDimUI();

      if(currentMode === '2d' && globalData.length > 0) build2DScene();
    }
    document.getElementById('langBtn').addEventListener('click', () => setLanguage(currentLang === 'ko' ? 'en' : 'ko'));

    // ìŠ¤ë§ˆíŠ¸ ë‹¨ìœ„ ë³€í™˜ í•¨ìˆ˜ (ëš±ëšœë£¨ ì „ìš©)
    function smartUnit(val) {
        if (!val || isNaN(val)) return 0;
        let num = parseFloat(val);
        // ê°’ì´ 100ë³´ë‹¤ í¬ë©´ mmë¡œ ê°„ì£¼í•˜ê³  më¡œ ë³€í™˜
        if (num > 100) return num / 1000;
        return num;
    }

    function splitCols(line) {
      const t = (line || '').trim();
      if (!t) return null;
      if (t.includes('ê³µê°„ID') || t.includes('ê³µê°„ëª…') || t.includes('ê°€ë¡œ(m)')) return null; // í—¤ë” ë¬´ì‹œ
      if (t.includes('\t')) return t.split('\t').map(s => s.trim());
      if (t.includes(',')) return t.split(',').map(s => s.trim());
      return t.split(/\s+/).map(s => s.trim());
    }

    function parseData() {
      const input = document.getElementById('dataInput').value || '';
      const lines = input.split(/\r?\n/);
      const parsed = [];

      lines.forEach(line => {
        const cols = splitCols(line);
        // êµ¬ê¸€ì‹œíŠ¸ êµ¬ì¡°: [0]ID, [1]ì´ë¦„, [2]ê°€ë¡œ, [3]ì„¸ë¡œ ... [7]ë²½ë†’ì´
        if (cols && cols.length >= 4 && cols[1]) {
          const id = parseInt(cols[0], 10) || 0; // IDê°€ ìˆ«ìê°€ ì•„ë‹ˆë©´ 0
          if (id === 0 && !cols[1]) return; // ì“°ë ˆê¸° ë°ì´í„° íŒ¨ìŠ¤

          let w = smartUnit(cols[2]);
          let d = smartUnit(cols[3]);
          let h = smartUnit(cols[7]);
          if (h === 0) h = 2.3; // ê¸°ë³¸ ë†’ì´ 2.3m

          if (w > 0 && d > 0) {
             const existing = globalData.find(item => item.id === id);
             const x2d = existing ? existing.x2d : null;
             const y2d = existing ? existing.y2d : null;
             parsed.push({ id, name: cols[1], w, d, h, x2d, y2d });
          }
        }
      });
      globalData = parsed;
      return parsed;
    }

    // ==========================================
    // 2. 2D ëª¨ë“œ
    // ==========================================
    const twodContainer = document.getElementById('twod-container');
    const SCALE_2D = 40;
    let active2DItem = null, active2DOffset = { x: 0, y: 0 };

    function save2DPositions() {
        const rooms = document.querySelectorAll('.room-2d.draggable');
        rooms.forEach(r => {
            const id = parseInt(r.dataset.id);
            const match = globalData.find(d => d.id === id);
            if(match) {
                match.x2d = r.style.left;
                match.y2d = r.style.top;
            }
        });
    }

    // ==========================================
    // [NEW] 2D ì¹˜ìˆ˜(ìë™ + ìˆ˜ë™) ìƒíƒœ/ë Œë”ë§
    // ==========================================
    let dimsVisible2D = false;
    let dimAddMode2D = false;
    let manualDims2D = [];
    let pendingDimPoint = null;

    let dimLayer2d = null;

    function updateDimUI(){
      const t = TRANSLATIONS[currentLang].dims;
      dimControls.style.display = (currentMode === '2d') ? 'flex' : 'none';

      dimToggleBtn.innerText = dimsVisible2D ? t.toggleOn : t.toggleOff;
      dimModeBtn.innerText = dimAddMode2D ? t.modeOn : t.modeOff;
      dimClearBtn.innerText = t.clear;

      dimToggleBtn.classList.toggle('on', dimsVisible2D);
      dimModeBtn.classList.toggle('on', dimAddMode2D);

      dimHint.style.display = (currentMode === '2d' && dimAddMode2D) ? 'block' : 'none';
    }

    function setDimsVisible2D(on){
      dimsVisible2D = !!on;
      if (dimLayer2d) dimLayer2d.classList.toggle('is-hidden', !dimsVisible2D);
      if (dimsVisible2D && currentMode === '2d') renderAllDims2D();
      updateDimUI();
    }

    function setDimAddMode2D(on){
      dimAddMode2D = !!on;
      if (dimAddMode2D) setDimsVisible2D(true);

      pendingDimPoint = null;
      clearPreviewDims2D();

      if (dimLayer2d) dimLayer2d.classList.toggle('dim-mode', dimAddMode2D);
      updateDimUI();
    }

    function formatM(v){
      const n = Number(v);
      if (!isFinite(n)) return '0';
      return n.toFixed(3).replace(/\.?0+$/,'');
    }

    function ensureDimLayer2D(){
      dimLayer2d = twodContainer.querySelector('#dimLayer2d');
      if (!dimLayer2d){
        dimLayer2d = document.createElementNS('http://www.w3.org/2000/svg','svg');
        dimLayer2d.id = 'dimLayer2d';
        twodContainer.appendChild(dimLayer2d);
      }

      dimLayer2d.innerHTML = `
        <defs>
          <marker id="dimArrow" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
            <path d="M0,0 L8,4 L0,8 Z" fill="#111"></path>
          </marker>
        </defs>
        <g id="autoDims"></g>
        <g id="manualDims"></g>
        <g id="dimPreview"></g>
      `;

      dimLayer2d.classList.toggle('is-hidden', !dimsVisible2D);
      dimLayer2d.classList.toggle('dim-mode', dimAddMode2D);

      if (!dimLayer2d._listenersAttached){
        dimLayer2d.addEventListener('pointerdown', onDimPointerDown2D);
        dimLayer2d.addEventListener('pointermove', onDimPointerMove2D);
        dimLayer2d.addEventListener('pointerleave', () => { clearPreviewDims2D(); });
        dimLayer2d._listenersAttached = true;
      }
    }

    function syncDimLayer2DSize(){
      if (!dimLayer2d) return;
      const w = Math.max(twodContainer.scrollWidth, twodContainer.clientWidth);
      const h = Math.max(twodContainer.scrollHeight, twodContainer.clientHeight);

      dimLayer2d.setAttribute('width', w);
      dimLayer2d.setAttribute('height', h);
      dimLayer2d.setAttribute('viewBox', `0 0 ${w} ${h}`);
      dimLayer2d.style.width = w + 'px';
      dimLayer2d.style.height = h + 'px';
    }

    function svgEl(tag, attrs){
      const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
      Object.entries(attrs || {}).forEach(([k,v]) => el.setAttribute(k, String(v)));
      return el;
    }

    function addDimText(group, x, y, text, rotateDeg = 0){
      const t = svgEl('text', {
        x, y,
        fill: '#111',
        'font-size': 12,
        'text-anchor': 'middle',
        'dominant-baseline': 'central',
        'paint-order': 'stroke',
        stroke: 'rgba(255,255,255,0.95)',
        'stroke-width': 5,
        style: 'font-family: Segoe UI, Malgun Gothic, sans-serif;'
      });
      t.textContent = text;
      if (rotateDeg){
        t.setAttribute('transform', `rotate(${rotateDeg} ${x} ${y})`);
      }
      group.appendChild(t);
    }

    function addLine(group, x1,y1,x2,y2, opts = {}){
      const line = svgEl('line', {
        x1,y1,x2,y2,
        stroke: opts.stroke || '#111',
        'stroke-width': opts.w || 1.2,
        'stroke-dasharray': opts.dash || '',
        'marker-start': opts.arrow ? 'url(#dimArrow)' : '',
        'marker-end': opts.arrow ? 'url(#dimArrow)' : ''
      });
      group.appendChild(line);
    }

    function addCircle(group, cx, cy, r=3){
      const c = svgEl('circle', { cx, cy, r, fill:'#111', stroke:'rgba(255,255,255,0.9)', 'stroke-width': 2 });
      group.appendChild(c);
    }

    function renderAutoDims2D(){
      if (!dimLayer2d) return;
      const autoGroup = dimLayer2d.querySelector('#autoDims');
      if (!autoGroup) return;
      autoGroup.innerHTML = '';

      const rooms = twodContainer.querySelectorAll('.room-2d.draggable');
      const off = 14;

      rooms.forEach(r => {
        const id = Number(r.dataset.id || 0);
        const d = globalData.find(x => x.id === id);
        if (!d) return;

        const x = parseFloat(r.style.left) || r.offsetLeft || 0;
        const y = parseFloat(r.style.top) || r.offsetTop || 0;
        const w = r.offsetWidth || 0;
        const h = r.offsetHeight || 0;

        // ê°€ë¡œ ì¹˜ìˆ˜(ìœ„ìª½)
        const yDim = y - off;
        addLine(autoGroup, x, y, x, yDim);
        addLine(autoGroup, x+w, y, x+w, yDim);
        addLine(autoGroup, x, yDim, x+w, yDim, {arrow:true});
        addDimText(autoGroup, x + w/2, yDim - 10, `${formatM(d.w)}m`);

        // ì„¸ë¡œ ì¹˜ìˆ˜(ì™¼ìª½)
        const xDim = x - off;
        addLine(autoGroup, x, y, xDim, y);
        addLine(autoGroup, x, y+h, xDim, y+h);
        addLine(autoGroup, xDim, y, xDim, y+h, {arrow:true});
        addDimText(autoGroup, xDim - 12, y + h/2, `${formatM(d.d)}m`, -90);
      });
    }

    function renderManualDims2D(){
      if (!dimLayer2d) return;
      const g = dimLayer2d.querySelector('#manualDims');
      if (!g) return;
      g.innerHTML = '';

      manualDims2D.forEach(dim => {
        const x1 = dim.x1, y1 = dim.y1, x2 = dim.x2, y2 = dim.y2;
        const dx = x2 - x1, dy = y2 - y1;
        const distPx = Math.hypot(dx, dy);
        const meters = distPx / SCALE_2D;

        addLine(g, x1, y1, x2, y2, {arrow:true, w:1.4});
        addCircle(g, x1, y1, 3);
        addCircle(g, x2, y2, 3);

        const mx = (x1 + x2) / 2;
        const my = (y1 + y2) / 2;

        let nx = 0, ny = 0;
        if (distPx > 0.0001){
          nx = -dy / distPx;
          ny = dx / distPx;
        }
        const labelX = mx + nx * 12;
        const labelY = my + ny * 12;

        const nearVertical = Math.abs(dx) < Math.abs(dy);
        if (nearVertical){
          addDimText(g, labelX, labelY, `${formatM(meters)}m`, -90);
        } else {
          addDimText(g, labelX, labelY, `${formatM(meters)}m`, 0);
        }
      });
    }

    function clearPreviewDims2D(){
      if (!dimLayer2d) return;
      const p = dimLayer2d.querySelector('#dimPreview');
      if (p) p.innerHTML = '';
    }

    function renderPreviewDims2D(p1, p2){
      if (!dimLayer2d) return;
      const p = dimLayer2d.querySelector('#dimPreview');
      if (!p) return;
      p.innerHTML = '';

      addLine(p, p1.x, p1.y, p2.x, p2.y, {dash:'6 4', stroke:'#111', w:1.2});
      addCircle(p, p1.x, p1.y, 3);
      addCircle(p, p2.x, p2.y, 3);

      const distPx = Math.hypot(p2.x - p1.x, p2.y - p1.y);
      const meters = distPx / SCALE_2D;
      const mx = (p1.x + p2.x)/2;
      const my = (p1.y + p2.y)/2;
      addDimText(p, mx, my - 12, `${formatM(meters)}m`);
    }

    function get2DPointFromClient(e){
      const rect = twodContainer.getBoundingClientRect();
      return {
        x: (e.clientX - rect.left) + twodContainer.scrollLeft,
        y: (e.clientY - rect.top) + twodContainer.scrollTop
      };
    }

    function applyAxisLock(p1, p2){
      const dx = p2.x - p1.x;
      const dy = p2.y - p1.y;
      if (Math.abs(dx) >= Math.abs(dy)){
        return { x: p2.x, y: p1.y }; // horizontal
      } else {
        return { x: p1.x, y: p2.y }; // vertical
      }
    }

    function onDimPointerDown2D(e){
      if (!dimAddMode2D || currentMode !== '2d') return;

      e.preventDefault();
      e.stopPropagation();

      const p = get2DPointFromClient(e);

      if (!pendingDimPoint){
        pendingDimPoint = p;
        renderPreviewDims2D(pendingDimPoint, pendingDimPoint);
        return;
      }

      let p2 = p;
      if (e.shiftKey){
        p2 = applyAxisLock(pendingDimPoint, p2);
      }

      manualDims2D.push({
        x1: pendingDimPoint.x, y1: pendingDimPoint.y,
        x2: p2.x, y2: p2.y,
        createdAt: Date.now()
      });

      pendingDimPoint = null;
      clearPreviewDims2D();
      renderManualDims2D();
    }

    function onDimPointerMove2D(e){
      if (!dimAddMode2D || currentMode !== '2d') return;
      if (!pendingDimPoint) return;

      const p = get2DPointFromClient(e);
      let p2 = p;

      if (e.shiftKey){
        p2 = applyAxisLock(pendingDimPoint, p2);
      }

      renderPreviewDims2D(pendingDimPoint, p2);
    }

    function renderAllDims2D(){
      if (currentMode !== '2d') return;
      ensureDimLayer2D();
      syncDimLayer2DSize();
      renderAutoDims2D();
      renderManualDims2D();
    }

    // UI ë²„íŠ¼ ì—°ê²°
    dimToggleBtn.addEventListener('click', () => setDimsVisible2D(!dimsVisible2D));
    dimModeBtn.addEventListener('click', () => setDimAddMode2D(!dimAddMode2D));
    dimClearBtn.addEventListener('click', () => {
      manualDims2D = [];
      pendingDimPoint = null;
      clearPreviewDims2D();
      if (dimsVisible2D && currentMode === '2d') renderAllDims2D();
    });

    // 2D ë“œë˜ê·¸ ì´ë²¤íŠ¸(ì¹˜ìˆ˜ ì¶”ê°€ ëª¨ë“œì—ì„  ë“œë˜ê·¸ ë¹„í™œì„±)
    twodContainer.addEventListener('pointerdown', e => {
      if (dimAddMode2D) return;
      const target = e.target.closest('.room-2d.draggable');
      if (!target) return;
      active2DItem = target; active2DItem.classList.add('dragging');
      const rect = active2DItem.getBoundingClientRect();
      active2DOffset.x = e.clientX - rect.left; active2DOffset.y = e.clientY - rect.top;
    });
    twodContainer.addEventListener('pointermove', e => {
      if (!active2DItem) return;
      e.preventDefault();
      const containerRect = twodContainer.getBoundingClientRect();
      const currentX = e.clientX - containerRect.left + twodContainer.scrollLeft;
      const currentY = e.clientY - containerRect.top + twodContainer.scrollTop;
      active2DItem.style.left = (currentX - active2DOffset.x) + 'px';
      active2DItem.style.top = (currentY - active2DOffset.y) + 'px';
    });
    twodContainer.addEventListener('pointerup', () => {
      if(active2DItem) {
        active2DItem.classList.remove('dragging');
        active2DItem = null;
        if (dimsVisible2D && currentMode === '2d') renderAutoDims2D();
      }
    });
    twodContainer.addEventListener('pointerleave', () => {
      if(active2DItem) {
        active2DItem.classList.remove('dragging');
        active2DItem = null;
        if (dimsVisible2D && currentMode === '2d') renderAutoDims2D();
      }
    });

    function build2DScene() {
      twodContainer.innerHTML = '';
      dimLayer2d = null;

      if (!globalData.length) return;
      const t = TRANSLATIONS[currentLang];

      const START_X = 400, START_Y = 70, LIMIT = 1000, GAP = 20;
      let currentX = START_X, currentY = START_Y, maxRowHeight = 0;
      let maxYPoint = 0;

      const title1 = document.createElement('div');
      title1.className = 'wall-section-title'; title1.innerText = t.section1; title1.style.top = '10px';
      twodContainer.appendChild(title1);

      globalData.forEach(d => {
        const color = EXCEL_COLORS[(d.id - 1) % EXCEL_COLORS.length] || "#ddd";
        const wPx = d.w * SCALE_2D, dPx = d.d * SCALE_2D;

        let posX, posY;
        if(d.x2d && d.y2d) {
            posX = d.x2d; posY = d.y2d;
        } else {
            if (currentX + wPx > START_X + LIMIT) { currentX = START_X; currentY += maxRowHeight + GAP; maxRowHeight = 0; }
            posX = currentX + 'px'; posY = currentY + 'px';
            currentX += wPx + GAP; maxRowHeight = Math.max(maxRowHeight, dPx);
        }

        const roomDiv = document.createElement('div');
        roomDiv.className = 'room-2d draggable';
        roomDiv.dataset.id = d.id;
        roomDiv.style.width = wPx + 'px'; roomDiv.style.height = dPx + 'px';
        roomDiv.style.backgroundColor = color;
        roomDiv.style.left = posX; roomDiv.style.top = posY;
        roomDiv.innerHTML = `<b>${d.name}</b><span>(${d.w} x ${d.d})</span>`;
        twodContainer.appendChild(roomDiv);

        const bottomEdge = parseFloat(posY) + dPx;
        if (bottomEdge > maxYPoint) maxYPoint = bottomEdge;
      });

      let wallStartY = Math.max(maxYPoint + 100, 600);

      const title2 = document.createElement('div');
      title2.className = 'wall-section-title unfolding'; title2.innerText = t.section2; title2.style.top = wallStartY + 'px';
      twodContainer.appendChild(title2);
      wallStartY += 60;

      globalData.forEach(d => {
        const color = EXCEL_COLORS[(d.id - 1) % EXCEL_COLORS.length] || "#ddd";
        const hPx = d.h * SCALE_2D;

        const perim = (d.w + d.d) * 2;
        const wallArea = perim * d.h;

        const roomLabel = document.createElement('div');
        roomLabel.style.position = 'absolute';
        roomLabel.style.left = '20px';
        roomLabel.style.top = (wallStartY + hPx/2 - 25) + 'px';
        roomLabel.style.lineHeight = '1.4';

        roomLabel.innerHTML = `
            <b style="font-size:14px;">[${d.name}]</b> <span style="font-size:11px; color:#666;">(H:${d.h}m)</span><br/>
            <span style="font-size:12px; color:#333;">
                ${t.tooltip.peri}: <b>${perim.toFixed(2)} m</b><br/>
                ${t.tooltip.wall}: <b>${wallArea.toFixed(2)} ã¡</b>
            </span>
        `;
        twodContainer.appendChild(roomLabel);

        let currentX = 160;
        const wNames = t.wallLabels;
        [{n:wNames[0],l:d.w}, {n:wNames[1],l:d.d}, {n:wNames[2],l:d.w}, {n:wNames[3],l:d.d}].forEach(w => {
            const wLenPx = w.l * SCALE_2D;
            const wallDiv = document.createElement('div');
            wallDiv.className = 'room-2d';
            wallDiv.style.width = wLenPx + 'px'; wallDiv.style.height = hPx + 'px';
            wallDiv.style.backgroundColor = color;
            wallDiv.style.left = currentX + 'px'; wallDiv.style.top = wallStartY + 'px';
            wallDiv.innerHTML = `<span>${w.n}</span><span style="font-size:10px">(${w.l}x${d.h})</span>`;
            twodContainer.appendChild(wallDiv);
            currentX += wLenPx + 10;
        });
        wallStartY += hPx + 50;
      });

      const finalSpacer = document.createElement('div');
      finalSpacer.style.position = 'absolute'; finalSpacer.style.top = wallStartY + 'px';
      finalSpacer.style.height = '100px'; finalSpacer.style.width = '10px';
      twodContainer.appendChild(finalSpacer);

      ensureDimLayer2D();
      syncDimLayer2DSize();
      if (dimsVisible2D) renderAllDims2D();
    }

    // ==========================================
    // 3. 3D íˆ¬ì‹œë„ ëª¨ë“œ
    // ==========================================
    const scene = new THREE.Scene(); scene.background = new THREE.Color(0xf0f0f0);
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(12, 12, 16); camera.lookAt(0, 0, 0);
    const renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
    renderer.setSize(window.innerWidth, window.innerHeight); renderer.shadowMap.enabled = true;
    document.getElementById('three-container').appendChild(renderer.domElement);
    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(50, 80, 50); dirLight.castShadow = true; scene.add(dirLight);
    const controls = new OrbitControls(camera, renderer.domElement); controls.enableDamping = true;
    scene.add(new THREE.GridHelper(100, 100, 0xbbbbbb, 0xeeeeee));

    let pieces = [], ghosts = [], hitMeshes = [], labels3D = [], labelsVisible = true;
    const raycaster = new THREE.Raycaster();
    let dragging = false, draggedGroup = null, dragOffset = new THREE.Vector3();
    let shiftDown = false, ghostsVisible = true;
    const tooltip = document.getElementById('tooltip');
    const canvasElement = renderer.domElement;

    function create3DRoom(d, colorHex) {
      const group = new THREE.Group();
      const w = d.w, depth = d.d, h = d.h;
      const matColor = new THREE.Color(colorHex);

      const floor = new THREE.Mesh(new THREE.PlaneGeometry(w, depth), new THREE.MeshStandardMaterial({ color: matColor, side: THREE.DoubleSide }));
      floor.rotation.x = -Math.PI/2; floor.position.y = 0.01; floor.receiveShadow = true; group.add(floor);

      const wallMat = new THREE.MeshStandardMaterial({ color: matColor, roughness: 0.7, transparent: true, opacity: 0.85 });
      const w1 = new THREE.Mesh(new THREE.BoxGeometry(w, h, 0.1), wallMat); w1.position.set(0, h/2, -depth/2); group.add(w1);
      const w2 = w1.clone(); w2.position.set(0, h/2, depth/2); group.add(w2);
      const w3 = new THREE.Mesh(new THREE.BoxGeometry(depth, h, 0.1), wallMat); w3.rotation.y = Math.PI/2; w3.position.set(-w/2, h/2, 0); group.add(w3);
      const w4 = w3.clone(); w4.rotation.y = Math.PI/2; w4.position.set(w/2, h/2, 0); group.add(w4);

      const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
      ctx.font = 'bold 40px Malgun Gothic'; const tW = ctx.measureText(d.name).width + 50;
      canvas.width = tW; canvas.height = 110;
      ctx.fillStyle = 'rgba(255,255,255,0.85)'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.strokeStyle = '#333'; ctx.lineWidth = 5; ctx.strokeRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#000'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(d.name, canvas.width/2, 35); ctx.font = '26px Malgun Gothic'; ctx.fillText(`(${d.w}x${d.d})`, canvas.width/2, 80);
      const label = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
      label.scale.set(tW/20, 5.5, 1); label.position.set(0, h + 2, 0);
      group.add(label); labels3D.push(label); if(!labelsVisible) label.visible = false;

      const hit = new THREE.Mesh(new THREE.PlaneGeometry(w, depth), new THREE.MeshBasicMaterial({visible:false}));
      hit.rotation.x = -Math.PI/2; hit.position.y = 0.1; hit.userData.parentGroup = group;
      group.add(hit); hitMeshes.push(hit);

      const floorArea = w * depth;
      const wallArea = (w + depth) * 2 * h;
      group.userData = {
          id: d.id, w, d: depth, h, targetPos: new THREE.Vector3(), name: d.name,
          metrics: { floor: floorArea, ceil: floorArea, peri: (w+depth)*2, wall: wallArea }
      };
      return group;
    }

    function build3DScene() {
      pieces.forEach(p => scene.remove(p)); ghosts.forEach(g => scene.remove(g));
      pieces = []; ghosts = []; hitMeshes = []; labels3D = [];
      let x = 0, z = 0, rowH = 0; const LIMIT = 25;
      globalData.forEach(d => {
        const color = EXCEL_COLORS[(d.id - 1) % EXCEL_COLORS.length] || "#cccccc";
        const group = create3DRoom(d, color);
        if (x + d.w > LIMIT) { x = 0; z += rowH + 0.5; rowH = 0; }
        group.userData.targetPos.set(x + d.w/2, 0, z + d.d/2);
        x += d.w + 0.5; rowH = Math.max(rowH, d.d);
        const ghost = new THREE.Mesh(new THREE.PlaneGeometry(d.w, d.d), new THREE.MeshBasicMaterial({ color: 0x000000, opacity: 0.15, transparent: true, side: THREE.DoubleSide }));
        ghost.rotation.x = -Math.PI/2; ghost.position.copy(group.userData.targetPos); ghost.position.y = 0.005;
        scene.add(ghost); ghosts.push(ghost);
        group.position.set(group.userData.targetPos.x + (Math.random()-0.5)*15, 0, group.userData.targetPos.z + 8 + Math.random()*8);
        scene.add(group); pieces.push(group);
      });
      ghosts.forEach(g => g.visible = ghostsVisible);
    }

    const tab2D = document.getElementById('tab2D'), tab3D = document.getElementById('tab3D');
    const threeContainerEl = document.getElementById('three-container');

    function switchMode(mode) {
      if(currentMode === '2d') save2DPositions();
      currentMode = mode;

      if (mode === '2d') {
        tab2D.className = 'tab-btn active'; tab3D.className = 'tab-btn inactive';
        twodContainer.style.display = 'block'; threeContainerEl.style.display = 'none';
        document.getElementById('info-2d').style.display = 'block'; document.getElementById('info-3d').style.display = 'none';
        tooltip.style.display = 'none';
        build2DScene();
        updateDimUI();
        if (dimsVisible2D && globalData.length) renderAllDims2D();
      } else {
        tab3D.className = 'tab-btn active'; tab2D.className = 'tab-btn inactive';
        twodContainer.style.display = 'none'; threeContainerEl.style.display = 'block';
        document.getElementById('info-2d').style.display = 'none'; document.getElementById('info-3d').style.display = 'block';
        if (globalData.length > 0 && pieces.length === 0) build3DScene();
        renderer.setSize(window.innerWidth, window.innerHeight); camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();

        if (dimAddMode2D) setDimAddMode2D(false);
        updateDimUI();
      }
    }
    tab2D.addEventListener('click', () => switchMode('2d'));
    tab3D.addEventListener('click', () => switchMode('3d'));

    document.getElementById('buildBtn').addEventListener('click', () => {
      parseData();
      if (globalData.length === 0) { alert(currentLang === 'ko'?"ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!":"Check Data!"); return; }
      if (currentMode === '2d') build2DScene(); else build3DScene();
      if (currentMode === '2d' && dimsVisible2D) renderAllDims2D();
    });

    function getMouse(e) {
        const rect = renderer.domElement.getBoundingClientRect();
        return { x: ((e.clientX - rect.left)/rect.width)*2 - 1, y: -((e.clientY - rect.top)/rect.height)*2 + 1 };
    }

    threeContainerEl.addEventListener('pointerdown', e => {
      if(!shiftDown || currentMode !== '3d') return;
      const m = getMouse(e); raycaster.setFromCamera(m, camera);
      const intersects = raycaster.intersectObjects(hitMeshes);
      if(intersects.length > 0) {
        dragging = true; draggedGroup = intersects[0].object.userData.parentGroup;
        controls.enabled = false; tooltip.style.display = 'none';
        canvasElement.style.cursor = 'grabbing';
        raycaster.ray.intersectPlane(new THREE.Plane(new THREE.Vector3(0, 1, 0), 0), dragOffset);
        dragOffset.sub(draggedGroup.position);
      }
    });

    threeContainerEl.addEventListener('pointermove', e => {
      const m = getMouse(e); raycaster.setFromCamera(m, camera);

      if(dragging && draggedGroup) {
        const p = new THREE.Vector3();
        raycaster.ray.intersectPlane(new THREE.Plane(new THREE.Vector3(0, 1, 0), 0), p);
        draggedGroup.position.copy(p.sub(dragOffset));
        return;
      }

      if(currentMode === '3d') {
          const intersects = raycaster.intersectObjects(hitMeshes);

          if(shiftDown && intersects.length > 0) {
             canvasElement.style.cursor = 'grab';
          } else {
             canvasElement.style.cursor = 'auto';
          }

          if(intersects.length > 0 && !dragging) {
              const u = intersects[0].object.userData.parentGroup.userData;
              const tt = TRANSLATIONS[currentLang].tooltip;
              tooltip.innerHTML = `
                <b>${u.name}</b>
                <div class="row"><span class="lbl">${tt.dim}</span> <span class="val">${u.w} x ${u.d} x ${u.h} m</span></div>
                <div class="row"><span class="lbl">${tt.floor}</span> <span class="val">${u.metrics.floor.toFixed(2)} ã¡</span></div>
                <div class="row"><span class="lbl">${tt.ceil}</span> <span class="val">${u.metrics.ceil.toFixed(2)} ã¡</span></div>
                <div class="row"><span class="lbl">${tt.peri}</span> <span class="val">${u.metrics.peri.toFixed(2)} m</span></div>
                <div class="row"><span class="lbl">${tt.wall}</span> <span class="val">${u.metrics.wall.toFixed(2)} ã¡</span></div>
              `;
              tooltip.style.display = 'block';
              tooltip.style.left = (e.clientX + 15) + 'px';
              tooltip.style.top = (e.clientY + 15) + 'px';
          } else {
              tooltip.style.display = 'none';
          }
      }
    });

    threeContainerEl.addEventListener('pointerup', () => {
      dragging = false; draggedGroup = null; controls.enabled = true;
      canvasElement.style.cursor = shiftDown ? 'grab' : 'auto';
    });
    threeContainerEl.addEventListener('pointerleave', () => {
      dragging = false; draggedGroup = null; controls.enabled = true;
      canvasElement.style.cursor = 'auto';
    });

    async function capture2D({ forceDims = false } = {}){
      const wasHidden = !dimsVisible2D;

      if (forceDims && currentMode === '2d') {
        setDimsVisible2D(true);
        renderAllDims2D();
      }

      const canvas = await html2canvas(document.getElementById('twod-container'));
      const link = document.createElement('a');
      link.download = '2D_Plan.png';
      link.href = canvas.toDataURL();
      link.click();

      if (forceDims && wasHidden) {
        setDimsVisible2D(false);
      }
    }

    window.addEventListener('keydown', async e => {
        const key = e.key.toLowerCase();
        if(key==='shift') shiftDown=true;

        if(key === 'h') {
          const a = document.activeElement;
          const isTyping = a && (a.tagName === 'TEXTAREA' || a.tagName === 'INPUT');
          if(!isTyping) setPanelCollapsed(!panelCollapsed);
        }

        if (currentMode === '2d') {
          if (key === 'd') {
            const a = document.activeElement;
            const isTyping = a && (a.tagName === 'TEXTAREA' || a.tagName === 'INPUT');
            if(!isTyping) setDimsVisible2D(!dimsVisible2D);
          }
          if (key === 'm') {
            const a = document.activeElement;
            const isTyping = a && (a.tagName === 'TEXTAREA' || a.tagName === 'INPUT');
            if(!isTyping) setDimAddMode2D(!dimAddMode2D);
          }
          if (key === 'escape') {
            if (dimAddMode2D) setDimAddMode2D(false);
            pendingDimPoint = null;
            clearPreviewDims2D();
          }
        }

        if(key === 'p') {
           if(currentMode === '2d') {
              if (e.shiftKey) await capture2D({ forceDims: true });
              else await capture2D({ forceDims: false });
           } else {
              renderer.render(scene, camera);
              const link=document.createElement('a');
              link.download='3D_View.png';
              link.href=renderer.domElement.toDataURL('image/png');
              link.click();
           }
        }

        if(currentMode === '3d') {
            if(key==='g') { ghostsVisible=!ghostsVisible; ghosts.forEach(g=>g.visible=ghostsVisible); }
            if(key==='l') { labelsVisible=!labelsVisible; labels3D.forEach(l=>l.visible=labelsVisible); }
        }
    });
    window.addEventListener('keyup', e => {
        if(e.key==='Shift') {
            shiftDown=false;
            canvasElement.style.cursor = 'auto';
        }
    });

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
      if(currentMode === '2d') {
        build2DScene();
        if (dimsVisible2D) renderAllDims2D();
      }
    });

    function animate() {
      requestAnimationFrame(animate);
      if(currentMode === '3d') { controls.update(); renderer.render(scene, camera); }
    }
    animate();

    setLanguage('ko');
    switchMode('3d');
  </script>
</body>
</html>
